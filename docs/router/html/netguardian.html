<link rel="stylesheet" href="../css/netguardian.css">

<div class="main" id="net_guard">
    <h4 class="page-title" data-i18n="">AI Net Guardian</h4>
    <div class="row">
        <div class="col-xs-8">
            <h4 class="content-title" data-i18n="lblTotalTraffic"></h4>
            <div id="totalTraffic"></div>
        </div>
        <div class="col-xs-4" id="subFunction">
            <h4 class="content-title" data-i18n="lblAIFunction"></h4>
            <div>
                <img src="../img/aiqos.png">
                <div class="fnIntro">
                    <div id="toQos">
                        <span>AI QoE</span>
                        <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span>
                    </div>
                    <div class="fnInfo">
                        <span data-i18n="lblMode"></span>&#58;&nbsp;
                        <span id="qoeStatus">--</span>
                    </div>
                </div>
            </div>
            <div>
                <img src="../img/pcontrol.png">
                <div class="fnIntro">
                    <div id="toParentControl">
                        <span data-i18n="tParentControl"></span>
                        <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span>
                    </div>
                    <div class="fnInfo">
                        <span data-i18n="lblKidProfile"></span>&#58;&nbsp;
                        <span id="kidsNum">0</span>
                    </div>
                </div>
            </div>
            <div>
                <img src="../img/no_ad.png">
                <div class="fnIntro">
                    <div id="toAdBlock">
                        <span data-i18n="lblAdBlock"></span>
                        <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span>
                    </div>
                    <div class="fnInfo">
                        <span data-i18n="lblStatus"></span>&#58;&nbsp;
                        <span id="adBlockStatus">--</span>
                    </div>
                </div>
            </div>
            <div>
                <img src="../img/anti_virus.png">
                <div class="fnIntro">
                    <div id="toAntiVirus">
                        <span data-i18n="lblMalWebBlock"></span>
                        <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span>
                    </div>
                    <div class="fnInfo">
                        <span data-i18n="lblStatus"></span>&#58;&nbsp;
                        <span id="adVirusStatus">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-7">
            <h4 class="content-title">
                <span data-i18n="lblTrafficByPriority"></span>
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active">
                        <a href="#upChart" aria-controls="upChart" role="tab" data-toggle="tab" data-i18n="lblUpl"></a>
                    </li>
                    <li role="presentation">
                        <a href="#downChart" aria-controls="downChart" role="tab" data-toggle="tab" data-i18n="lblDownl"></a>
                    </li>
                </ul>
            </h4>
            <div class="tab-content">
                <div role="tabpanel" class="tab-pane active clearfix" id="upChart">
                    <div class="pull-left" id="priorityUpTraffic"></div>
                    <div class="priorityData pull-right">
                        <div>
                            <span data-i18n="lblPass"></span>
                            <span id="passUpPriData"></span>
                        </div>
                        <div>
                            <span data-i18n="lblExtreme"></span>
                            <span id="extremeUpPriData"></span>
                        </div>
                        <div>
                            <span data-i18n="lblHigh"></span>
                            <span id="highUpPriData"></span>
                        </div>
                        <div>
                            <span data-i18n="lblMedium"></span>
                            <span id="mediumUpPriData"></span>
                        </div>
                        <div>
                            <span data-i18n="lblLow"></span>
                            <span id="lowUpPriData"></span>
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane clearfix" id="downChart">
                    <div class="pull-left" id="priorityDownTraffic"></div>
                    <div class="priorityData pull-right">
                        <div>
                            <span data-i18n="lblPass"></span>
                            <span id="passDownPriData"></span>
                        </div>
                        <div>
                            <span data-i18n="lblExtreme"></span>
                            <span id="extremeDownPriData"></span>
                        </div>
                        <div>
                            <span data-i18n="lblHigh"></span>
                            <span id="highDownPriData"></span>
                        </div>
                        <div>
                            <span data-i18n="lblMedium"></span>
                            <span id="mediumDownPriData"></span>
                        </div>
                        <div>
                            <span data-i18n="lblLow"></span>
                            <span id="lowDownPriData"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xs-5">
            <h4 class="content-title" data-i18n="lblTotalTrafficByPriority"></h4>
            <div class="clearfix" id="totalChart">
                <div class="pull-left" id="totalPriorityTraffic"></div>
                <div class="priorityData pull-right">
                    <div>
                        <span data-i18n="lblPass"></span>
                        <span id="passTotalData"></span>
                    </div>
                    <div>
                        <span data-i18n="lblExtreme"></span>
                        <span id="extremeTotalData"></span>
                    </div>
                    <div>
                        <span data-i18n="lblHigh"></span>
                        <span id="highTotalData"></span>
                    </div>
                    <div>
                        <span data-i18n="lblMedium"></span>
                        <span id="mediumTotalData"></span>
                    </div>
                    <div>
                        <span data-i18n="lblLow"></span>
                        <span id="lowTotalData"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../public/static/echarts.min.js"></script>
<script>
    try{
        $;
    }catch(e){
        window.sessionStorage.setItem("page", "netguardian.html");
        window.location.replace("./index.html");
    }

    $(document).ready(function(){
        var xAxisData = [];
        var trafficData = [
            [new Array(60), new Array(60)],   // total
            [new Array(60), new Array(60)],   // pass
            [new Array(60), new Array(60)],   // extreme
            [new Array(60), new Array(60)],   // high
            [new Array(60), new Array(60)],   // medium
            [new Array(60), new Array(60)],   // low
        ];  // 0: up; 1: down
        var pieData = [{name: 'pass', value: 0}, {name: 'extreme', value: 0}, {name: 'high', value: 0},
                       {name: 'medium', value: 0}, {name: 'low', value: 0}];
        var lastChartData = [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0]];
        var now = new Date(), valueName, initData, counter = 0;
        for (var i = 0; i < 60; i++) {
            xAxisData.unshift(i);
            initData = updateTimeLineData(1, 0);
            updateTrafficData(trafficData[0], [initData, initData]);
            updateTrafficData(trafficData[1], [initData, initData]);
            updateTrafficData(trafficData[2], [initData, initData]);
            updateTrafficData(trafficData[3], [initData, initData]);
            updateTrafficData(trafficData[4], [initData, initData]);
            updateTrafficData(trafficData[5], [initData, initData]);
        }
        // init charts
        var totalChart = initLineChart("totalTraffic", ["#EC5145", "#6283A8"], ["upl", "downl"], [trafficData[0][0], trafficData[0][1]],
                                    {xInterval: 2, gridBottom: 15});
        var priUpChart = initLineChart("priorityUpTraffic", ["#64C39B", "#E23829", "#F4AF48", "#5E7FA6", "#A0A0A0"], ["pass", "extreme", "high", "medium", "low"],
                                    [trafficData[1][0], trafficData[2][0], trafficData[3][0], trafficData[4][0], trafficData[5][0]],
                                    {xInterval: 4, gridBottom: 15});
        var priDownChart = initLineChart("priorityDownTraffic", ["#64C39B", "#E23829", "#F4AF48", "#5E7FA6", "#A0A0A0"], ["pass", "extreme", "high", "medium", "low"],
                                    [trafficData[1][1], trafficData[2][1], trafficData[3][1], trafficData[4][1], trafficData[5][1]],
                                    {xInterval: 4, gridBottom: 15});
        var priTotalPie = echarts.init(document.getElementById("totalPriorityTraffic"));
        priTotalPie.setOption({
            color: ["#64C39B", "#E23829", "#F4AF48", "#5E7FA6", "#A0A0A0"],
            legend: {
                show: true,
                orient: 'horizontal',
                bottom: 0,
                textStyle: {color: 'auto', fontSize: 14},
                data: ['pass', 'extreme', 'high', 'medium', 'low'],
                formatter: function(name) {
                    var tValue = 0, total = 0;
                    pieData.forEach(function(v){
                        if (name == v.name) {
                            tValue = v.value;
                        }
                        total += v.value;
                    });
                    total = total || 1;
                    // return $.t("lbl"+name.replace(name.charAt(0), name.charAt(0).toUpperCase()))+': '+(tValue/total*100).toFixed(2)+"%";
                    $("#"+name+"TotalData").text((tValue/total*100).toFixed(2)+"%");
                    return $.t("lbl"+name.replace(name.charAt(0), name.charAt(0).toUpperCase()));
                }
            },
            tooltip: {
                show: true,
                trigger: 'item',
                showContent: true,
                showDelay: 20,
                hideDelay: 100,
                transitionDuration: 0.4,
                backgroundColor: 'rgba(255, 255, 255, 1)',
                textStyle: {color: '#000'},
                formatter: function(p){
                    var cName = p.name;
                    return p.marker+$.t("lbl"+cName.replace(cName.charAt(0), cName.charAt(0).toUpperCase()))+": "+ p.value+"("+p.percent+"%)";
                }
            },
            series: [{
                name: "total",
                type: "pie",
                center: ['50%', '35%'],
                radius: "65%",
                avoidLabelOverlap: false,
                hoverAnimation: true,
                label: {show: false},
                labelLine: {show: false},
                data: pieData
            }]
        });

        getStatus();
        var updateTimer = setInterval(updateData, 1000);
        timer.push(updateTimer);

        $("#enableAINet").on("change", function(){
            startLoading(4000, $.t("lblSave"));
        });

        $("#toQos").on("click", function(){
            window.sessionStorage.setItem("toPage", "/setting/aiqoe.html");
            $("[href='setting.html']")[0].click();
        });

        $("#toParentControl").on("click", function(){
            window.sessionStorage.setItem("toPage", "/setting/parent_control.html");
            $("[href='setting.html']")[0].click();
        });

        $("#toAdBlock").on("click", function(){
            window.sessionStorage.setItem("toPage", "/setting/adblock.html");
            $("[href='setting.html']")[0].click();
        });

        $("#toAntiVirus").on("click", function(){
            window.sessionStorage.setItem("toPage", "/setting/malwebblock.html");
            $("[href='setting.html']")[0].click();
        });

        $("a[role='tab']").on({
            "click": function(e){
                e.preventDefault();
            },
            "shown.bs.tab": function(){
                priUpChart.resize();
                priDownChart.resize();
            }
        });

        $(window).resize(function() {
            totalChart.resize();
            priUpChart.resize();
            priDownChart.resize();
            priTotalPie.resize();
        });

        function initLineChart(id, colors, dataNames, data, opt) {
            var chart = echarts.init(document.getElementById(id));
            var seriesData = [];
            dataNames.forEach(function(v, i){
                seriesData.push({
                    name: v,
                    type: 'line',
                    smooth: true,
                    symbol: "none",
                    itemStyle: {
                        normal: {
                            color: colors[i],
                            lineStyle: {width: 1, color: colors[i]}
                        }
                    },
                    data: data[i]
                });
            });
            var option = {
                grid: {
                    left: 30,
                    right: 10,
                    top: 20,
                    bottom: opt.gridBottom,
                    containLabel: true
                },
                legend: {
                    bottom: 0,
                    padding: [10, 0, 0, 0],
                    icon: 'path://M928 896H96a53.393333 53.393333 0 0 1-53.333333-53.333333V181.333333a53.393333 53.393333 0 0 1 53.333333-53.333333h832a53.393333 53.393333 0 0 1 53.333333 53.333333v661.333334a53.393333 53.393333 0 0 1-53.333333 53.333333zM96 170.666667a10.666667 10.666667 0 0 0-10.666667 10.666666v661.333334a10.666667 10.666667 0 0 0 10.666667 10.666666h832a10.666667 10.666667 0 0 0 10.666667-10.666666V181.333333a10.666667 10.666667 0 0 0-10.666667-10.666666z',
                    data: dataNames,
                    type: 'scroll',
                    formatter: function(name) {
                        if (id != "totalTraffic") {
                            var value = 0;
                            for (var i = 0, len = dataNames.length; i < len; i++) {
                                if (name === dataNames[i]) {
                                    value = data[i][59].value[1];
                                    $("#"+name+(id=="priorityUpTraffic"?"Up":"Down")+"PriData").text(value+" Mbps");
                                    break;
                                }
                            }
                        }
                        // return $.t("lbl"+name.replace(name.charAt(0), name.charAt(0).toUpperCase()))+': '+data[index][59].value[1];
                        return $.t("lbl"+name.replace(name.charAt(0), name.charAt(0).toUpperCase()));
                    },
                    textStyle: {fontSize: 14, color: 'auto', padding: [2, 0, 0, 0]},
                },
                tooltip: {
                    show: true,
                    trigger: "axis",
                    showContent: true,
                    showDelay: 20,
                    hideDelay: 60,
                    transitionDuration: 0.4,
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    borderRadius: 4,
                    borderWidth: 0,
                    padding: 5,
                    axisPointer: {
                        type: 'line',
                        lineStyle: {
                            color: '#ccc',
                            width: 1,
                            type: 'solid'
                        }
                    },
                    formatter: function(p){
                        var res = "";
                        p.forEach(function(v, i){
                            if (i == 0) {
                                res = v.axisValueLabel;
                            }
                            var sName = v.seriesName;
                            res += "<div>"+v.marker+$.t("lbl"+sName.replace(sName.charAt(0), sName.charAt(0).toUpperCase()))
                                +": <span style='float:right;font-weight:bold;'>"+v.value[1]+"</span><div style='clear:both'></div></div>";
                        });
                        return res;
                    }
                },
                xAxis: [
                    {
                        show: false,
                        type: "time",
                        splitLine: {show: false}
                    },
                    {
                        name: 'Second',
                        position: "bottom",
                        type: "category",
                        data: xAxisData,
                        boundaryGap: false,
                        axisLine: {
                            onZero: true,
                            lineStyle: {color: "#E1E5EC"}
                        },
                        axisTick: {
                            alignWithLabel: true,
                            interval: opt.xInterval,
                            length: 8,
                            lineStyle: {color: "#E1E5EC"}
                        },
                        axisLabel: {
                            margin: 15,
                            rotate: 30,
                            interval: opt.xInterval,
                            color: "#838383"
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {color: "#E1E5EC"}
                        },
                        nameLocation: 'center',
                        nameGap: 30,
                        nameTextStyle: {color: '#333333', fontSize: 14}
                    }
                ],
                yAxis: [
                    {
                        name: 'Mbps',
                        type: "value",
                        axisLine: {
                            show: true,
                            lineStyle: {color: "#E1E5EC"}
                        },
                        axisTick: {
                            show: true,
                            lineStyle: {color: "#E1E5EC"}
                        },
                        axisLabel: {
                            margin: 15,
                            color: "#838383"
                        },
                        splitLine: {
                            lineStyle: {
                                color: "#E1E5EC",
                                type: "solid",
                                width: 1
                            }
                        },
                        nameLocation: 'center',
                        nameGap: 40,
                        nameTextStyle: {
                            color: '#333333',
                            fontSize: 14
                        }
                    }
                ],
                series: seriesData
            };
            chart.setOption(option);
            return chart;
        }

        function updateTrafficData(arr, data) {
            // update chart data
            data[0].value[1] = (data[0].value[1] * 8 / 1024 / 1024).toFixed(3);
            data[1].value[1] = (data[1].value[1] * 8 / 1024 / 1024).toFixed(3);
            arr[0].shift();
            arr[0].push(data[0]);
            arr[1].shift();
            arr[1].push(data[1]);
        }

        function updateTimeLineData(flag, v) {
            // change data to time line data
            if (flag) {
                now = new Date(+now + 1000);
                valueName = now.getFullYear() + '/' + (now.getMonth() + 1) + '/' + now.getDate()
                            + ' ' + now.getHours().toString().padStrStart(2) + ':' + now.getMinutes().toString().padStrStart(2)
                            + ':' + now.getSeconds().toString().padStrStart(2);
            }

            return {name: now.toString(), value: [valueName, v.toFixed(3)]};
        }

        function getStatus() {
            ajax({
                url: "ai.json",
                success: function(data) {
                    if (data.error == 0) {
                        // update function's info
                        var mode = "";
                        switch(data.qoe.mode){
                            case "ai":
                                mode = "lblAIMode";
                                break;
                            case "game":
                                mode = "lblGameMode";
                                break;
                        }
                        $("#qoeStatus").text($.t(mode));
                        $("#kidsNum").text(data.control_num);
                        $("#adBlockStatus").text($.t(data.ad.enable ? "lblop" : "lbldo"));
                        $("#adVirusStatus").text($.t(data.mal.enable ? "lblop" : "lbldo"));

                        var allData = data.traffic.statistics;
                        var num = allData.counter;
                        var check = num > 0 ? num - counter : 1;

                        updateTrafficData(trafficData[0], [updateTimeLineData(1, (allData.total_traffic[0]-lastChartData[0][0])/check), updateTimeLineData(0, (allData.total_traffic[1]-lastChartData[0][1])/check)])
                        totalChart.setOption({series: [{data: trafficData[0][0]}, {data: trafficData[0][1]}]});

                        updateTrafficData(trafficData[1], [updateTimeLineData(0, (allData.pass_traffic[0]-lastChartData[1][0])/check), updateTimeLineData(0, (allData.pass_traffic[1]-lastChartData[1][1])/check)])
                        updateTrafficData(trafficData[2], [updateTimeLineData(0, (allData.highest_traffic[0]-lastChartData[2][0])/check), updateTimeLineData(0, (allData.highest_traffic[1]-lastChartData[2][1])/check)])
                        updateTrafficData(trafficData[3], [updateTimeLineData(0, (allData.high_traffic[0]-lastChartData[3][0])/check), updateTimeLineData(0, (allData.high_traffic[1]-lastChartData[3][1])/check)])
                        updateTrafficData(trafficData[4], [updateTimeLineData(0, (allData.medium_traffic[0]-lastChartData[4][0])/check), updateTimeLineData(0, (allData.medium_traffic[1]-lastChartData[4][1])/check)])
                        updateTrafficData(trafficData[5], [updateTimeLineData(0, (allData.low_traffic[0]-lastChartData[5][0])/check), updateTimeLineData(0, (allData.low_traffic[1]-lastChartData[5][1])/check)])

                        priUpChart.setOption({series: [{data: trafficData[1][0]}, {data: trafficData[2][0]}, {data: trafficData[3][0]}, {data: trafficData[4][0]}, {data: trafficData[5][0]}]});
                        priDownChart.setOption({series: [{data: trafficData[1][1]}, {data: trafficData[2][1]}, {data: trafficData[3][1]}, {data: trafficData[4][1]}, {data: trafficData[5][1]}]});

                        pieData[0].value = allData.pass_traffic[0]+allData.pass_traffic[1];
                        pieData[1].value = allData.highest_traffic[0]+allData.highest_traffic[1];
                        pieData[2].value = allData.high_traffic[0]+allData.high_traffic[1];
                        pieData[3].value = allData.medium_traffic[0]+allData.medium_traffic[1];
                        pieData[4].value = allData.low_traffic[0]+allData.low_traffic[1];
                        priTotalPie.setOption({series: [{ data: pieData }]});

                        // save the last data
                        lastChartData[0][0] = allData.total_traffic[0];
                        lastChartData[0][1] = allData.total_traffic[1];

                        lastChartData[1][0] = allData.pass_traffic[0];
                        lastChartData[1][1] = allData.pass_traffic[1];

                        lastChartData[2][0] = allData.highest_traffic[0];
                        lastChartData[2][1] = allData.highest_traffic[1];

                        lastChartData[3][0] = allData.high_traffic[0];
                        lastChartData[3][1] = allData.high_traffic[1];

                        lastChartData[4][0] = allData.medium_traffic[0];
                        lastChartData[4][1] = allData.medium_traffic[1];

                        lastChartData[5][0] = allData.low_traffic[0];
                        lastChartData[5][1] = allData.low_traffic[1];

                        counter = num;
                    } else {
                        locationUrl(data.error);
                    }
                }
            });
        }

        function updateData() {
            var num = counter+getRandomNum(1, 10);
            var check = num > 0 ? num - counter : 1;

            var total_traffic_change = [getRandomNum(0, 600), getRandomNum(0, 600)];
            var pass_traffic_change = [getRandomNum(0, 200), getRandomNum(0, 100)];
            var highest_traffic_change = [getRandomNum(0, 100), getRandomNum(0, 200)];
            var high_traffic_change = [getRandomNum(0, 120), getRandomNum(0, 100)];
            var medium_traffic_change = [getRandomNum(0, 80), getRandomNum(0, 150)];
            var low_traffic_change = [getRandomNum(0, 100), getRandomNum(0, 50)];

            // save the last data
            lastChartData[0][0] += total_traffic_change[0];
            lastChartData[0][1] += total_traffic_change[1];

            lastChartData[1][0] += pass_traffic_change[0];
            lastChartData[1][1] += pass_traffic_change[1];

            lastChartData[2][0] += highest_traffic_change[0];
            lastChartData[2][1] += highest_traffic_change[1];

            lastChartData[3][0] += high_traffic_change[0];
            lastChartData[3][1] += high_traffic_change[1];

            lastChartData[4][0] += medium_traffic_change[0];
            lastChartData[4][1] += medium_traffic_change[1];

            lastChartData[5][0] += low_traffic_change[0];
            lastChartData[5][1] += low_traffic_change[1];

            counter = num;

            updateTrafficData(trafficData[0], [updateTimeLineData(1, total_traffic_change[0]/check), updateTimeLineData(0, total_traffic_change[1]/check)])
            totalChart.setOption({series: [{data: trafficData[0][0]}, {data: trafficData[0][1]}]});

            updateTrafficData(trafficData[1], [updateTimeLineData(0, pass_traffic_change[0]/check), updateTimeLineData(0, pass_traffic_change[1]/check)])
            updateTrafficData(trafficData[2], [updateTimeLineData(0, highest_traffic_change[0]/check), updateTimeLineData(0, highest_traffic_change[1]/check)])
            updateTrafficData(trafficData[3], [updateTimeLineData(0, high_traffic_change[0]/check), updateTimeLineData(0, high_traffic_change[1]/check)])
            updateTrafficData(trafficData[4], [updateTimeLineData(0, medium_traffic_change[0]/check), updateTimeLineData(0, medium_traffic_change[1]/check)])
            updateTrafficData(trafficData[5], [updateTimeLineData(0, low_traffic_change[0]/check), updateTimeLineData(0, low_traffic_change[1]/check)])

            priUpChart.setOption({series: [{data: trafficData[1][0]}, {data: trafficData[2][0]}, {data: trafficData[3][0]}, {data: trafficData[4][0]}, {data: trafficData[5][0]}]});
            priDownChart.setOption({series: [{data: trafficData[1][1]}, {data: trafficData[2][1]}, {data: trafficData[3][1]}, {data: trafficData[4][1]}, {data: trafficData[5][1]}]});

            pieData[0].value = lastChartData[1][0]+lastChartData[1][1];
            pieData[1].value = lastChartData[2][0]+lastChartData[2][1];
            pieData[2].value = lastChartData[3][0]+lastChartData[3][1];
            pieData[3].value = lastChartData[4][0]+lastChartData[4][1];
            pieData[4].value = lastChartData[5][0]+lastChartData[5][1];
            priTotalPie.setOption({series: [{ data: pieData }]});
        }

        function getRandomNum(min, max) {
            return Math.floor(Math.random(0, 1)*max+min);
        }
    });
</script>
