<div class="page-content row">
    <div class="col-xs-9 content">
        <div class="form-group row includeAddRule">
            <button type="button" class="btn btn-default" id="addRule">
                <img src="../img/add.png">
                <span data-i18n="btnAddExtender"></span>
            </button>
        </div>
        <div class="row">
            <table class="table">
                <thead>
                    <tr>
                        <th data-i18n="lblStatus"></th>
                        <th data-i18n="lblName"></th>
                        <th data-i18n="lblAddr"></th>
                        <th data-i18n="lblMACAddressName"></th>
                        <th data-i18n="lblSignal"></th>
                        <th data-i18n="lblOperate"></th>
                    </tr>
                </thead>
                <tbody id="meshList">
                    <tr><td colspan="6"><img src="../public/static/layer/skin/default/loading-2.gif" width="20px"></td></tr>
                </tbody>
            </table>
        </div>
        <h5 class="depart-line collapsed theme-border-color theme-color"
            data-toggle="collapse" href="#advanceSetting"
            aria-expanded="false" aria-controls="advanceSetting">
            <span data-i18n="tAdSetting"></span>
            <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span>
        </h5>
        <div class="collapse" id="advanceSetting">
            <div id="bandSteeringInfo" class="off">
                <div class="form-group row">
                    <label class="col-xs-8 control-label">BandSteering</label>
                    <div class="col-xs-4 text-right">
                        <div class="switch">
                            <input class="switch-checkbox hidden" id="enableBandSteering" type="checkbox">
                            <label class="switch-label" for="enableBandSteering">
                                <span class="switch-inner"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblBSThreshold_2"></label>
                    <div class="col-xs-5 input-group">
                        <input type="text" class="form-control" id="threshold_2g">
                        <span class="input-group-addon">dBm</span>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblBSThreshold_5"></label>
                    <div class="col-xs-5 input-group">
                        <input type="text" class="form-control" id="threshold_5g">
                        <span class="input-group-addon">dBm</span>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-xs-8 control-label">Roaming</label>
                <div class="col-xs-4 text-right">
                    <div class="switch">
                        <input class="switch-checkbox hidden" id="enableRoaming" type="checkbox">
                        <label class="switch-label" for="enableRoaming">
                            <span class="switch-inner"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="form-group row" id="roamingInfo">
                <label class="col-xs-7 control-label" data-i18n="lblRoamingThresholds"></label>
                <div class="col-xs-5 input-group">
                    <input type="text" class="form-control" id="thresholdRoaming">
                    <span class="input-group-addon">dBm</span>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-xs-4 control-label" data-i18n="lblTopologyOptimization"></label>
                <div class="col-xs-offset-6 col-xs-2">
                    <button class="btn btn-primary theme-bg-color" id="optimize" data-i18n="btnOptimization"></button>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-xs-7 control-label" data-i18n="lbltpupdateThresholds"></label>
                <div class="col-xs-5 input-group">
                    <input type="text" class="form-control" id="thresholdtpupdate">
                    <span class="input-group-addon">dBm</span>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-4 col-xs-offset-4">
                    <button class="btn btn-primary theme-bg-color" id="setRoaming" data-i18n="btnSaveName"></button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xs-3 help">
        <h4 data-i18n="lblHelp"></h4>

        <h5>Roaming</h5>
        <p data-i18n="msgRoming"></p>

        <h5 data-i18n="lblRoamingThresholds"></h5>
        <p data-i18n="msgRoamingThreshold"></p>

        <h5 data-i18n="lblTopologyOptimization"></h5>
        <p data-i18n="msgTopologyOptimization"></p>

        <h5 data-i18n="lbltpupdateThresholds"></h5>
        <p data-i18n="msgtpupdateThreshold"></p>
    </div>
</div>

<div class="modal fade" id="addMeshModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header theme-border-color">
                <button type="button" id="meshClear" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h5 class="modal-title text-center" id="addMeshModalLabel" data-i18n="lblAddExtender"></h5>
            </div>
            <div class="modal-body text-center">
                <div id="meshTip1">
                    <img src="../img/tu1.png">
                    <div class="tips">
                        <div data-i18n="msgAddExtender1"></div>
                        <div data-i18n="msgAddExtender2"></div>
                    </div>
                </div>
                <div id="meshTip2" class="off">
                    <img src="../img/tu2.png">
                    <div class="tips">
                        <div data-i18n="msgAddExtender3"></div>
                        <div data-i18n="msgAddExtender4"></div>
                    </div>
                </div>
                <div id="scanLoading" class="off">
                    <img src="../img/loading.gif" width="90px">
                    <div data-i18n="lblScaning"></div>
                </div>
                <div id="meshTable" class="off">
                    <table class="table">
                        <thead>
                            <tr>
                                <th data-i18n="lblName"></th>
                                <th data-i18n="lblPairKey"></th>
                                <th data-i18n="lblselectable"></th>
                            </tr>
                        </thead>
                        <tbody id="mesh_scan_list"></tbody>
                    </table>
                </div>
                <div id="noExtender" class="off">
                    <div data-i18n="msgNoExtender"></div>
                    <div class="tips">
                        <div data-i18n="msgAddExtender6"></div>
                        <div data-i18n="msgAddExtender7"></div>
                    </div>
                </div>
                <div id="btn-row">
                    <button type="button" class="btn btn-primary theme-bg-color" id="meshNextBtn" data-i18n="btnNextName"></button>
                    <button type="button" class="btn btn-primary theme-bg-color off" id="meshPreBtn" data-i18n="btnPreviousName"></button>
                    <button type="button" class="btn btn-primary theme-bg-color off" id="scanMeshList" data-i18n="btnStartScan"></button>
                    <button type="button" class="btn btn-primary theme-bg-color off" id="addMeshList" data-i18n="btnAddExtender"></button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
	try{
		$;
	}catch(e){
		window.sessionStorage.setItem("page", "/setting/mesh_list.html");
		window.location.replace("./index.html");
	}

    $(document).ready(function(){
        var agent_list = [];
        var imgHtml = "<img class='editName' src='../img/edit.png' width='18px' />";
        getAgentInfo();

        $("#addRule").on("click", function(){
            $("#addMeshModal").modal("show");
        });
        // 点击编辑按钮
        $("#meshList").on("click", ".editName", function(){
            var index = $(this).parents("tr").prevAll().length-1;
            var thisTd = $(this).parent();
            thisTd.html("<input type='text' class='form-control changeName' value='"+agent_list[index].name+"'>");
            thisTd.find(".changeName").focus();
        });
        // 编辑当前节点的名称
        $("#meshList").on("focusout", ".changeName", function(){
            var index = $(this).parents("tr").prevAll().length-1;
            var thisTd = $(this).parent();
            var newName = $(this).val();
            var oldName = agent_list[index].name;

            if (oldName == newName) {
                thisTd.html(oldName+imgHtml);
                return false;
            } else if (!newName.length) {
                getMsg($.t("msgTerminalText1"), 2, this);
                return false;
            } else if (!SsidLenCheck(newName, 31)) {
                getMsg($.t("msgTerminalText2"), 2, this);
                return false;
            } else if (!checkSpecialCharacter2(newName)) {
                getMsg($.t("msgTerminalText3"), 2, this);
                return false;
            }

            thisTd.html(newName+imgHtml);
        });
        $("#meshList").on("click", ".deleteThis:not(.disabled)", function(){
            var index = $(this).parents("tr").prevAll().length-1;
            startLoading(2000, $.t("btnSaveName"));
            $(this).parents("tr").remove();
            agent_list.splice(index, 1);
        });
        $(".depart-line[data-toggle='collapse']").on("click", function(){
            var target = $(this);
            target.find(".glyphicon").attr("class", function(i, v){
                return target.hasClass("collapsed") ? v.replace("right", "down") : v.replace("down", "right");
            });
        });
        $("#enableRoaming").on("change", function(){
            $(this).is(":checked") ? $("#roamingInfo").show() : $("#roamingInfo").hide();
        });
        $("#enableBandSteering").on("change", function(){
            var target = $(this).parents("form-group").nextAll();
            $(this).is(":checked") ? target.show() : target.hide();
        });
        $("#optimize").on("click", function(){
            startLoading(2000, $.t("btnOptimization"));
        });
        $("#addMeshModal .close").on("click", function(){
            meshChangeStep(1);
        });
        $("#meshNextBtn").on("click", function(){
            meshChangeStep(2);
        });
        $("#meshPreBtn").on("click", function(){
            meshChangeStep($("#meshTip2").is(":visible") ? 1 : 2);
        });
        // scan mesh list
        $("#scanMeshList").on("click", function(){
            meshChangeStep(3);
        });
        $("#addMeshList").on("click", function(){
            var mesh_list = "", checkedTr = $(".selectThis:checked"), agentNum = agent_list.length;
            checkedTr.each(function(){
                mesh_list += (mesh_list.length > 0 ? ";" : "") + $(this).val();
            });
            if (!mesh_list.length) {
                getMsg($.t("msgAddExtenderTip"));
                return false;
            }
            if ((checkedTr.length + agentNum) > 9) {
                getMsg($.t("msgMeshListFull"));
                return false;
            }
            addMeshList();
        });
        $("#loadingModal").on("click", "#closeLoadingBtn", function(){
            $("#loadingModal").modal("hide");
            $("#loadingModal .modal-title").text($.t("lblSave"));
            $("#loadingModal .modal-body").html("<img src='../img/loading.gif'>");
            $("#meshList").append($("<tr><td><img src='../img/mesh_extender.png' /></td><td>"+htmlEscape("Extender")+imgHtml+"</td>\
                                <td>192.168.10.24</td><td>8*:**:**:**:4A:5B</td><td>"+$.t(rssiConvert(-40))+"</td>\
                                <td><span class='deleteThis'>"+$.t("btnDelete")+"</span></td></tr>")[0]);
        });

        $("#setRoaming").on("click", function(){
            var bs_enable = $("#enableBandSteering").val();
            var bs_threshold_2 = $("#threshold_2g").val();
            var bs_threshold_5 = $("#threshold_5g").val();
            var roaming_enable = $("#enableRoaming").val();
            var roaming_threshold = $("#thresholdRoaming").val();
            var topo_update_threshold = $("#thresholdtpupdate").val();

            if (parseInt(bs_threshold_2) < -62 || parseInt(bs_threshold_2) > -42||bs_threshold_2=="") {
                getMsg($.t('msgBSThresholderror_2'));
                return 0;
            }
            if (parseInt(bs_threshold_5) < -85 || parseInt(bs_threshold_5) > -65||bs_threshold_5=="") {
                getMsg($.t('msgBSThresholderror_5'));
                return 0;
            }
            if (parseInt(roaming_threshold) < -75 || parseInt(roaming_threshold) > -55||roaming_threshold=="") {
                getMsg($.t('msgRoamingThresholderror'));
                return 0;
            }
            if (parseInt(topo_update_threshold) < -75 || parseInt(topo_update_threshold) > -65||topo_update_threshold=="") {
                getMsg($.t('msgTopoThresholderror'));
                return 0;
            }
            startLoading(2000, $.t("btnSaveName"));
        });

        function getAgentInfo() {
            $("#meshList").html("<tr><td colspan='6'><img src='../public/static/layer/skin/default/loading-2.gif' width='20px'></td></tr>");
            $.when(ajax({url: "system.json"}), ajax({url: "network.json"})).done(function(r0, r1) {
                if (r0[0].error == 0 && r1[0].error == 0) {
                    var cpe_bridge_mode = r0[0].sys.MeshBridgeMode;
                    var meshArray = r1[0].mesh.topology;
                    agent_list = r1[0].mesh.agent_list;
                    var router_ip = r1[0].lan.ip;

                    var dom = document.createDocumentFragment();
                    var thisMac = meshArray[0].pairKey.toUpperCase();

                    dom.appendChild($("<tr><td><img src='../img/mesh_router.png'></td>\
                                    <td>Router</td><td>"+router_ip+"</td>\
                                    <td>"+thisMac.slice(0, 1)+"*:**:**:**:" +thisMac.slice(-5)+"</td>\
                                    <td></td><td></td></tr>")[0]);

                    agent_list.forEach(function(v) {
                        var isOnline = 0, extender_ip = v.ip_addr, pair_key = v.pair_key, rssi = 0;
                        meshArray.some(function(m, i) {
                            if (i > 0) {
                                if (pair_key.toLowerCase() == m.pairKey) {
                                    // online agent
                                    extender_ip = (!extender_ip.length || cpe_bridge_mode == 1) ? m["Br-LanIP"] : extender_ip;
                                    rssi = (m.BHLType == 2 ? 0 : m.rssi);
                                    isOnline = 1;
                                    return true;
                                }
                            }
                        });

                        dom.appendChild($("<tr><td><img src='../img/mesh_extender"+(isOnline ? "" : "_off")+".png' /></td>\
                                        <td>"+htmlEscape(v.name)+(isOnline ? imgHtml : "")+"</td>\
                                        <td>"+(isOnline ? extender_ip : "*")+"</td>\
                                        <td>"+pair_key.slice(0, 1)+"*:**:**:**:"+pair_key.slice(-5)+"</td>\
                                        <td>"+(isOnline ? $.t(rssiConvert(rssi)) : "*")+"</td>\
                                        <td><span class='deleteThis'>"+$.t("btnDelete")+"</span></td></tr>")[0]);
                    });
                    $("#meshList").html(dom);

                    var mesh_advance = r1[0].mesh.advance;
                    $("#enableBandSteering").prop("checked", (mesh_advance.bs_enable == 1)).change();
                    $("#threshold_2g").val(mesh_advance.bs_threshold_2);
                    $("#threshold_5g").val(mesh_advance.bs_threshold_5);

                    $("#enableRoaming").prop("checked", (mesh_advance.roaming_enable == 1)).change();
                    $("#thresholdRoaming").val(mesh_advance.roaming_threshold);
                    $("#thresholdtpupdate").val(mesh_advance.threshold_topo_update);
                }
            });
        }

        function rssiConvert(rssi) {
            var a = parseInt(rssi);
            if (a >= -55) {
                return "lblHighSignal";
            } else if (a >= -73 && a < -55) {
                return "lblMiddleSignal";
            } else if (a < -73) {
                return "lblLowSignal";
            }
        }

        function addMeshList() {
            meshChangeStep(1);
            $("#loadingModal .modal-title").text($.t("lblAdding"));
            $("#addMeshModal").modal("hide");
            $("#loadingModal").modal("show");
            setTimeout(function() {
                $("#loadingModal .modal-title").text($.t("lblAddSuccess"));
                $("#loadingModal .modal-body").html("<div class='form-group text'>"+$.t("msgAddAfterExplain")+"</div>\
                <button class='btn btn-primary theme-bg-color' id='closeLoadingBtn'>"+$.t("msgReload")+"</button>");
            }, 3000);
        }

        function getMeshScanList() {
            ajax({
                url: "network.json",
                success: function(data) {
                    if(data.error == 0){
                        var mesh_scan_list = [], htmlScanList = "";
                        data.mesh.scan_list.some(function(v, i) {
                            var pair_key = v.pair_key;
                            if (i == 0 || mesh_scan_list.indexOf(pair_key) == -1) {
                                mesh_scan_list.push(pair_key);
                                htmlScanList += "<tr><td>Extender_"+ pair_key.replace(/:/g, "").slice(-4)+"</td>\
                                                 <td>"+pair_key.slice(0, 1)+"*:**:**:**:"+pair_key.slice(-5)+"</td>\
                                                 <td><input type='checkbox' class='selectThis' value='"+pair_key+"'></td></tr>";
                            }
                            return mesh_scan_list.length == 10;
                        });

                        $("#scanLoading").hide();
                        $("#scanMeshList").text($.t("btnRestartScan"));
                        $("#btn-row, #meshPreBtn, #scanMeshList").show();

                        if (!htmlScanList.length) {
                            $("#noExtender").show();
                        } else {
                            $("#mesh_scan_list").html(htmlScanList);
                            $("#meshTable, #addMeshList").show();
                        }
                    } else {
                        locationUrl(data.error);
                    }
                }
            });
        }

        function meshChangeStep(step) {
            $("#addMeshModal").find(".modal-body > div, #btn-row > .btn").hide();
            switch (step) {
                case 1 :
                    $("#meshTip1, #btn-row, #meshNextBtn").show();
                    break;
                case 2 :
                    $("#addMeshList").hide();
                    $("#meshTip2, #btn-row, #meshPreBtn, #scanMeshList").show();
                    $("#scanMeshList").html($.t("btnStartScan"));
                    break;
                case 3 :
                    $("#scanLoading").show();
                    setTimeout(getMeshScanList, 3000);
                    break;
            }
        }
    });
</script>
