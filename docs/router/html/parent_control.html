<div class="page-content row">
	<div class="col-xs-9 content" id="parent_control">
		<div class="form-group row">
			<div class="col-xs-4 col-xs-offset-4">
				<button class="btn btn-primary theme-bg-color" id="addControlRule" data-i18n="btnAddExtender"></button>
			</div>
		</div>
		<div id="control_list"></div>
	</div>
	<div class="col-xs-3 help">
		<h4 data-i18n="lblHelp"></h4>
	</div>
</div>

<div class="modal fade" id="pControlModal">
    <div class="modal-dialog">
        <div class="modal-content theme-border-color">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
				<input type="hidden" id="nowUser">
                <div class="form-group row">
                    <label class="col-xs-8 control-label" data-i18n="lblArkManage"></label>
                    <div class="col-xs-4 text-right">
                        <div class="switch">
                            <input class="switch-checkbox hidden" id="enableSmart" type="checkbox">
                            <label class="switch-label" for="enableSmart">
                                <span class="switch-inner"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div id="allControlSettings">
                    <ul class="nav nav-tabs form-group" role="tablist">
                        <li role="presentation" class="active">
                            <a href="#basic" aria-controls="basic" role="tab" data-toggle="tab" data-i18n="lblArkBasic"></a>
                        </li>
                        <li role="presentation">
                            <a href="#lock" aria-controls="lock" role="tab" data-toggle="tab" data-i18n="lblArkBlock"></a>
                        </li>
                        <li role="presentation">
                            <a href="#schedule" aria-controls="schedule" role="tab" data-toggle="tab" data-i18n="lblTimeManage"></a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active" id="basic">
                            <div class="form-group row">
                                <label class="col-xs-3 control-label" data-i18n="lblArkUser"></label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" id="pUserName">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-xs-3 control-label" data-i18n="lblMACAddressName"></label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" id="pUserMAC">
                                </div>
                                <div class="col-xs-2">
                                    <button class="btn btn-default" id="addMAC" data-i18n="btnAddExtender"></button>
                                </div>
                            </div>
                            <div id="macList" class="gray-bg list"></div>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="lock">
                            <div class="row" id="lockAppTag">
                                <div class="col-xs-3">
                                    <h5 class="title" data-i18n="lblBlockType"></h5>
                                </div>
                                <div class="col-xs-4 col-xs-push-5">
                                    <div class="input-group">
                                        <input class="form-control" id="appFilterInput" type="text" data-i18n="[placeholder]lblSearchApp">
                                        <span class="input-group-btn">
                                            <button class="btn btn-default" type="button" id="appFindButton" data-i18n="btnSearch"></button>
                                        </span>
                                        <ul id="appFindDropdown"></ul>
                                    </div>
                                </div>
                            </div>
                            <div class="gray-bg" id="appTypeList"></div>
                            <h5 class="title" data-i18n="lblBlockKeyword"></h5>
                            <div class="gray-bg">
                                <div class="form-group row">
                                    <div class="col-xs-4">
                                        <input type="text" class="form-control" id="pKeyword">
                                    </div>
                                    <div class="col-xs-2">
                                        <button class="btn btn-default" id="addKeyword" data-i18n="btnAddExtender"></button>
                                    </div>
                                </div>
                                <div id="keywordList" class="list"></div>
                            </div>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="schedule">
                            <h5 class="title" data-i18n="lblEveryWeek"></h5>
                            <div class="form-group row">
                                <label class="col-xs-7 control-label" data-i18n="lblScheduleType"></label>
                                <div class="col-xs-5">
                                    <select class="form-control" id="dateType">
                                        <option value="4" data-i18n="lblScheduleWorkday"></option>
                                        <option value="5" data-i18n="lblScheduleWeekend2"></option>
                                        <option value="6" data-i18n="lblScheduleAllday"></option>
                                        <option value="1" data-i18n="lblScheduleDayall"></option>
                                        <option value="2" data-i18n="lblScheduleWeek"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group row off">
                                <label class="col-xs-7 control-label" data-i18n="lblScheduleWeek"></label>
                                <div class="col-xs-5">
                                    <select class="form-control" id="weekType">
                                        <option value="7" data-i18n="lblScheduleSun"></option>
                                        <option value="1" data-i18n="lblScheduleMon"></option>
                                        <option value="2" data-i18n="lblScheduleTue"></option>
                                        <option value="3" data-i18n="lblScheduleWed"></option>
                                        <option value="4" data-i18n="lblScheduleThur"></option>
                                        <option value="5" data-i18n="lblScheduleFri"></option>
                                        <option value="6" data-i18n="lblScheduleSat"></option>
                                    </select>
                                </div>
                            </div>
                            <h5 class="title" data-i18n="lblPeriod"></h5>
                            <div>
								<div class="rule" id="Sometime">
									<div class="select dropdown">
										<input type="hidden" id="startHour1" value="00">
										<div class="dropdown-toggle text-center" id="startHourSelect1" data-toggle="dropdown">00</div>
										<ul class="dropdown-menu" role="menu" aria-labelledby="startHourSelect1">
											<li data-value="00">00</li>
											<li data-value="01">01</li>
											<li data-value="02">02</li>
											<li data-value="03">03</li>
											<li data-value="04">04</li>
											<li data-value="05">05</li>
											<li data-value="06">06</li>
											<li data-value="07">07</li>
											<li data-value="08">08</li>
											<li data-value="09">09</li>
											<li data-value="10">10</li>
											<li data-value="11">11</li>
											<li data-value="12">12</li>
											<li data-value="13">13</li>
											<li data-value="14">14</li>
											<li data-value="15">15</li>
											<li data-value="16">16</li>
											<li data-value="17">17</li>
											<li data-value="18">18</li>
											<li data-value="19">19</li>
											<li data-value="20">20</li>
											<li data-value="21">21</li>
											<li data-value="22">22</li>
											<li data-value="23">23</li>
										</ul>
									</div>
									<div class="time">:</div>
									<div class="select dropdown">
										<input type="hidden" id="startMin1" value="00">
										<div class="dropdown-toggle text-center" id="startMinSelect1" data-toggle="dropdown">00</div>
										<ul class="dropdown-menu" role="menu" aria-labelledby="startMinSelect1">
											<li data-value="00">00</li>
											<li data-value="01">01</li>
											<li data-value="02">02</li>
											<li data-value="03">03</li>
											<li data-value="04">04</li>
											<li data-value="05">05</li>
											<li data-value="06">06</li>
											<li data-value="07">07</li>
											<li data-value="08">08</li>
											<li data-value="09">09</li>
											<li data-value="10">10</li>
											<li data-value="11">11</li>
											<li data-value="12">12</li>
											<li data-value="13">13</li>
											<li data-value="14">14</li>
											<li data-value="15">15</li>
											<li data-value="16">16</li>
											<li data-value="17">17</li>
											<li data-value="18">18</li>
											<li data-value="19">19</li>
											<li data-value="20">20</li>
											<li data-value="21">21</li>
											<li data-value="22">22</li>
											<li data-value="23">23</li>
											<li data-value="24">24</li>
											<li data-value="25">25</li>
											<li data-value="26">26</li>
											<li data-value="27">27</li>
											<li data-value="28">28</li>
											<li data-value="29">29</li>
											<li data-value="30">30</li>
											<li data-value="31">31</li>
											<li data-value="32">32</li>
											<li data-value="33">33</li>
											<li data-value="34">34</li>
											<li data-value="35">35</li>
											<li data-value="36">36</li>
											<li data-value="37">37</li>
											<li data-value="38">38</li>
											<li data-value="39">39</li>
											<li data-value="40">40</li>
											<li data-value="41">41</li>
											<li data-value="42">42</li>
											<li data-value="43">43</li>
											<li data-value="44">44</li>
											<li data-value="45">45</li>
											<li data-value="46">46</li>
											<li data-value="47">47</li>
											<li data-value="48">48</li>
											<li data-value="49">49</li>
											<li data-value="50">50</li>
											<li data-value="51">51</li>
											<li data-value="52">52</li>
											<li data-value="53">53</li>
											<li data-value="54">54</li>
											<li data-value="55">55</li>
											<li data-value="56">56</li>
											<li data-value="57">57</li>
											<li data-value="58">58</li>
											<li data-value="59">59</li>
										</ul>
									</div>
									<div class="time">~</div>
									<div class="select dropdown">
										<input type="hidden" id="endHour1" value="00">
										<div class="dropdown-toggle text-center" id="endHourSelect1" data-toggle="dropdown">00</div>
										<ul class="dropdown-menu" role="menu" aria-labelledby="endHourSelect1">
											<li data-value="00">00</li>
											<li data-value="01">01</li>
											<li data-value="02">02</li>
											<li data-value="03">03</li>
											<li data-value="04">04</li>
											<li data-value="05">05</li>
											<li data-value="06">06</li>
											<li data-value="07">07</li>
											<li data-value="08">08</li>
											<li data-value="09">09</li>
											<li data-value="10">10</li>
											<li data-value="11">11</li>
											<li data-value="12">12</li>
											<li data-value="13">13</li>
											<li data-value="14">14</li>
											<li data-value="15">15</li>
											<li data-value="16">16</li>
											<li data-value="17">17</li>
											<li data-value="18">18</li>
											<li data-value="19">19</li>
											<li data-value="20">20</li>
											<li data-value="21">21</li>
											<li data-value="22">22</li>
											<li data-value="23">23</li>
										</ul>
									</div>
									<div class="time">:</div>
									<div class="select dropdown">
										<input type="hidden" id="endMin1" value="00">
										<div class="dropdown-toggle text-center" id="endMinSelect1" data-toggle="dropdown">00</div>
										<ul class="dropdown-menu" role="menu" aria-labelledby="endMinSelect1">
											<li data-value="00">00</li>
											<li data-value="01">01</li>
											<li data-value="02">02</li>
											<li data-value="03">03</li>
											<li data-value="04">04</li>
											<li data-value="05">05</li>
											<li data-value="06">06</li>
											<li data-value="07">07</li>
											<li data-value="08">08</li>
											<li data-value="09">09</li>
											<li data-value="10">10</li>
											<li data-value="11">11</li>
											<li data-value="12">12</li>
											<li data-value="13">13</li>
											<li data-value="14">14</li>
											<li data-value="15">15</li>
											<li data-value="16">16</li>
											<li data-value="17">17</li>
											<li data-value="18">18</li>
											<li data-value="19">19</li>
											<li data-value="20">20</li>
											<li data-value="21">21</li>
											<li data-value="22">22</li>
											<li data-value="23">23</li>
											<li data-value="24">24</li>
											<li data-value="25">25</li>
											<li data-value="26">26</li>
											<li data-value="27">27</li>
											<li data-value="28">28</li>
											<li data-value="29">29</li>
											<li data-value="30">30</li>
											<li data-value="31">31</li>
											<li data-value="32">32</li>
											<li data-value="33">33</li>
											<li data-value="34">34</li>
											<li data-value="35">35</li>
											<li data-value="36">36</li>
											<li data-value="37">37</li>
											<li data-value="38">38</li>
											<li data-value="39">39</li>
											<li data-value="40">40</li>
											<li data-value="41">41</li>
											<li data-value="42">42</li>
											<li data-value="43">43</li>
											<li data-value="44">44</li>
											<li data-value="45">45</li>
											<li data-value="46">46</li>
											<li data-value="47">47</li>
											<li data-value="48">48</li>
											<li data-value="49">49</li>
											<li data-value="50">50</li>
											<li data-value="51">51</li>
											<li data-value="52">52</li>
											<li data-value="53">53</li>
											<li data-value="54">54</li>
											<li data-value="55">55</li>
											<li data-value="56">56</li>
											<li data-value="57">57</li>
											<li data-value="58">58</li>
											<li data-value="59">59</li>
										</ul>
									</div>
								</div>
								<button class="btn btn-default" id="addTime" data-i18n="btnAddExtender"></button>
                            </div>
                            <div id="timeList" class="gray-bg list"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-xs-3 col-xs-offset-3">
                        <button type="button" class="btn btn-default" data-dismiss="modal" data-i18n="btnCancel"></button>
                    </div>
                    <div class="col-xs-3">
                        <button type="button" class="btn btn-primary theme-bg-color" id="pControlSave" data-i18n="btnSaveName"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="logModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header theme-border-color">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title" data-i18n="lblLog"></h4>
			</div>
			<div class="modal-body">
				<div id="logList">
					<div class="per-page row">
						<div class="col-xs-12">
							<span data-i18n="lblDisplayPerPage"></span>
							<div class="dropdown select selectPerPage">
								<input type="hidden" class="perPage" value="10">
								<button class="form-control dropdown-toggle" data-toggle="dropdown">10</button>
								<ul class="dropdown-menu" role="menu">
									<li data-value="5">5</li>
									<li data-value="10">10</li>
									<li data-value="15">15</li>
								</ul>
							</div>
						</div>
					</div>
					<table class="table">
						<thead>
							<tr>
								<th data-i18n="lblTime"></th>
								<th data-i18n="lblMACAddressName"></th>
								<th data-i18n="lblAppWebsite"></th>
								<th data-i18n="lblBehavior"></th>
							</tr>
						</thead>
						<tbody>
							<tr><td colspan="4"><img src="../public/static/layer/skin/default/loading-2.gif" width="20px"></td></tr>
						</tbody>
					</table>
					<div class="pagination-box">
						<span data-i18n="lblTableFooter"></span>
						<ul class="pagination">
							<li><span class="startPage" aria-label="Start" aria-hidden="true">&laquo;</span></li>
							<li><span class="prevPage" aria-label="Previous" aria-hidden="true">&lt;</span></li>
							<li class="active"><span class="nowPage">1</span></li>
							<li><span class="nextPage" aria-label="Next" aria-hidden="true">&gt;</span></li>
							<li><span class="endPage" aria-label="End" aria-hidden="true">&raquo;</span></li>
						</ul>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<div class="row">
					<div class="col-xs-4 col-xs-offset-4">
						<button type="button" class="btn btn-primary theme-bg-color" data-dismiss="modal" data-i18n="lblTurnOFF"></button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
    try{
        $;
    }catch(e){
        window.sessionStorage.setItem("page", "/setting/parent_control.html");
        window.location.replace("./index.html");
    }

	$(document).ready(function(){
		var pctrlDom = {
			domList: $("#control_list"),
			empty: function(){
				this.domList.empty();
			},
			onSwitch: function (userName, on) {
				$("#pctrl_on_" + userName).text($.t(on != 0 ? "tr069_Enable" : "tr069_Disable"));
			},
			add: function(userName, on) {
				on = parseInt(on);
				this.domList.append(
					"<div class='item' id='pctrl_"+userName+"'>\
						<div class='row'>\
							<label class='control-label'>"+$.t("lblArkUser")+"</label>\
							<div>"+userName+"</div>\
						</div>\
						<div class='row'>\
							<label class='control-label'>"+$.t("lblStatus")+"</label>\
							<div id='pctrl_on_"+userName+"'>"+$.t(on ? "tr069_Enable" : "tr069_Disable")+"</div>\
						</div>\
						<div class='row'>\
							<label class='control-label'>"+$.t("lblMACAddressName")+"</label>\
							<div>++</div>\
						</div>\
						<hr class='depart-line'>\
						<div class='text-right'>\
							<span class='checkBtn'>"+$.t("btnCheckLog")+"</span>\
							<span class='editBtn'>"+$.t("lblEdit")+"</span>\
							<span class='deleteBtn'>"+$.t("btnDelete")+"</span>\
						</div>\
					</div>");
			},
			del: function(userName) {
				$("#pctrl_"+userName).remove();
			}
		}

		var ruleDom = {
			catEleme: function(catId, value, more) {
				return "<div class='check-item' data-cat_id='"+catId+"' data-cat_value='"+value+"'>\
							<input type='checkbox' id='cat_input_"+catId+"' value='"+catId+"' data-more='"+more+"' data-cat_id='" + catId + "'>\
							<label for='cat_input_"+catId+"'>"+
							(more?"<div class='dropdown'>\
									<a href='#' class='dropdown-toggle' data-toggle='dropdown'>"+value+"</a>\
									<ul class='dropdown-menu' id='cat_ul_"+catId+"'></ul>\
								</div>":value)+
							"</label>\
						</div>";
			},
			appEleme: function(id, catId, appId, value, selected) {
				return "<li>\
							<input type='checkbox' id='"+id+appId+"' data-app_id='"+appId+"' data-parent_id='"+catId+"' "+(selected?"checked":"")+">\
							<label for='"+id+appId+"'>"+value+"</label>\
						</li>";
			},
			catFindEleme: function (catId, value) {
				return "<li data-cat_filter_id='"+catId+"' data-cat_value='"+value+"'>"+value+"<span class='caret'></span></li>";
			},
			appInputSelected: function(appTypeList, catId, appId, selected) {
				appTypeList.find(':checkbox[data-app_id="'+appId+'"]').prop("checked", selected).closest("li").prependTo(appTypeList.find("#cat_ul_"+catId));
				this.catInputSelected(appTypeList, catId, selected);
			},
			catInputSelected: function(appTypeList, catId) {
				appTypeList.find("#cat_input_"+catId).prop("checked", appTypeList.find("#cat_ul_"+catId+" :checked").length != 0);
			},
			appFindInputSelected: function(appFindDropdown, appId, selected) {
				appFindDropdown.find(':checkbox[data-app_id="'+appId+'"]').prop("checked", selected);
			},
		}

		var schedule = {
			init: function (modal) {
				this.dateType = modal.find("#dateType");
				this.weekType = modal.find("#weekType");
				this.stHour = modal.find("#startHour1");
				this.stMinute = modal.find("#startMin1");
				this.etHour = modal.find("#endHour1");
				this.etMinute = modal.find("#endMin1");
				this.addTime = modal.find("#addTime");
				this.timeList = modal.find("#timeList");
				this.someTime = modal.find("#Sometime");
				this.domTimeStrs = [];
			},
			empty: function () {
				this.timeList.empty();
				this.dateType.val(4);
				this.weekType.parent().parent().hide();
				this.stHour.val("00");
				this.someTime.find("#startHourSelect1").data('value', "00").text("00");
				this.stMinute.val("00");
				this.someTime.find("#startMinSelect1").data('value', "00").text("00");
				this.etHour.val("00");
				this.someTime.find("#endHourSelect1").data('value', "00").text("00");
				this.etMinute.val("00");
				this.someTime.find("#endMinSelect1").data('value', "00").text("00");
				this.someTime.show();
				this.domTimeStrs = [];
			},
			scheduleParse: function (time) {
				if (time.length > 4) {
					time = time.slice(0, 4);
				}

				for (var i = 0; i < time.length; i++) {
					var arr = time[i].split(';');
					if (arr.length != 3) {
						continue;
					}
					var stArr = [];
					var etArr = [];
					try {
						stArr = JSON.parse(arr[1]);
						etArr = JSON.parse(arr[2]);
					} catch (error) {
						continue;
					}
					var stHour = stArr[4];
					var stMin = stArr[5];
					var etHour = etArr[4];
					var etMin = etArr[5];
					var stWeek = stArr[3];
					var etWeek = etArr[3];

					if (stHour < 0 || stHour > 23 || etHour < 0 || etHour > 23) {
						continue;
					}

					if (stMin < 0 || stMin > 59 || etMin < 0 || etMin > 59) {
						continue;
					}

					if (stWeek < 0 || stWeek > 7 || etWeek < 0 || etWeek > 7) {
						continue;
					}

					var timeStr = this.domTimeStr(arr[0], String(stHour).padStart(2, '0'), String(stMin).padStart(2, '0'), String(etHour).padStart(2, '0'), String(etMin).padStart(2, '0'), stWeek);

					if (timeStr.length <= 0) {
						continue;
					}
					this.domTimeStrs.push(timeStr);
				}
			},
			domTimeStr: function(dateType, startHour, startMin, endHour, endMin, weekType) {
				var thisValue = "";
				var limitTime = dateType + "-"+ weekType +"-" + parseInt(startHour) + "-" + parseInt(startMin) + "-" + parseInt(endHour) + "-" + parseInt(endMin);

				if(dateType == "4") {
					thisValue = $.t("lblScheduleWorkday")+" | " + startHour + ":" + startMin + "-" + endHour + ":" + endMin;
				} else if (dateType == "5") {
					thisValue = $.t("lblScheduleWeekend2")+" | " + startHour + ":" + startMin + "-" + endHour + ":" + endMin;
				} else if (dateType == "6") {
					thisValue = $.t("lblScheduleAllday");
				} else if (dateType == "1") {
					thisValue = $.t("lblScheduleDayall")+" | " + startHour + ":" + startMin + "-" + endHour + ":" + endMin;
				} else if (dateType == "2") {
					switch(weekType.toString())
					{
						case "1":
							thisValue = $.t("lblScheduleMon");
							break;
						case "2":
							thisValue = $.t("lblScheduleTue");
							break;
						case "3":
							thisValue = $.t("lblScheduleWed");
							break;
						case "4":
							thisValue = $.t("lblScheduleThur");
							break;
						case "5":
							thisValue = $.t("lblScheduleFri");
							break;
						case "6":
							thisValue = $.t("lblScheduleSat");
							break;
						case "7":
							thisValue = $.t("lblScheduleSun");
							break;
						default:
							return ""
					}
					thisValue = thisValue+" | " + startHour + ":" + startMin + "-" + endHour + ":" + endMin;
				}

				var pHtml = "<div><span value="+ limitTime +">"+thisValue+"</span><span class='delete'>&times;</span></div>";

				return pHtml;
			},
			domSet: function() {
				this.timeList.empty();
				this.domTimeStrs.forEach(function(pHtml){
					schedule.timeList.append(pHtml);
				});
			},
			domGet: function() {
				var timeArr = [], res = [];
				this.timeList.children().each(function(){
					timeArr.push($(this).children("span:first").attr("value"));
				});

				for (var i = 0, len=timeArr.length; i < len && i < 4; ++i) {
					var splitArray = timeArr[i].split("-");
					if (splitArray.length != 6) {
						continue;
					}
					if (splitArray[0] != '2') {
						splitArray[1] = '0';
					}

					if (splitArray[0] == '6') {
						splitArray[2] = '0'
						splitArray[3] = '0';
						splitArray[4] = '0';
						splitArray[5] = '0';
					}
					res.push(splitArray[0]+";[0,0,0,"+parseInt(splitArray[1])+","+parseInt(splitArray[2])+","+parseInt(splitArray[3])+"];[0,0,0,"+parseInt(splitArray[1])+","+parseInt(splitArray[4])+","+parseInt(splitArray[5])+"]");
				}

				return res;
			},
			scheduleLoad: function (userName){
				pctrl.user.some(function(v){
					if (v.user_name == userName) {
						schedule.empty();
						var schedule_data = v.schedule_info;
						if (schedule_data.time.length > 4) {
							schedule_data.time.slice(0, 4);
						}
						targetModal.elem.time = schedule_data.time;
						targetModal.elem.on = schedule_data.on;
						targetModal.elem.schedule = schedule_data.time.length;

						var user = pctrl.find(targetModal.elem.user_name);
						pctrl.scheduleSize = pctrl.scheduleSize - user.schedule + schedule_data.time.length;
						user.schedule = schedule_data.time.length;
						user.on = schedule_data.on;

						pctrlDom.onSwitch(targetModal.elem.user_name, targetModal.elem.on);
						targetModal.onSwitch(targetModal.elem.on);

						schedule.scheduleParse(targetModal.elem.time);
						schedule.domSet();
						return true;
					}
				});
			}
		};

		var rule = {
			init: function(modal) {
				this.appFindButton = modal.find("#appFindButton");
				this.appTypeList = modal.find("#appTypeList");
				this.appFindDropdown = modal.find("#appFindDropdown");
				this.pKeyword = modal.find("#pKeyword");
				this.addKeyword = modal.find("#addKeyword");
				this.keywordList = modal.find("#keywordList");
				this.appFilterInput = modal.find("#appFilterInput");

				this.appList = {};
				this.catList = {};

				this.appIdlication = {};
				this.keywordlication = [];
				this.catIdlication = [];
			},
			event: function () {
				this.appTypeList.on("click", "li", function(e) {
					e.stopPropagation();
				});
				this.appTypeList.on("click", ":checkbox[data-app_id]", function(e) {
					e.stopPropagation();
					var catId = $(this).attr("data-parent_id");
					ruleDom.catInputSelected(rule.appTypeList, catId);
				});
				this.appTypeList.on("click", "div[data-cat_id] > input[type='checkbox']", function(e) {
					e.stopPropagation();
					if (!$(this).attr("data-more")) {
						return;
					}
					var isChecked = $(this).prop("checked");
					var catId = $(this).val()
					rule.appTypeList.find('input[data-parent_id="' + catId + '"]').prop("checked", isChecked);
				});
				this.appFindDropdown.on("click", "li", function(e) {
					e.stopPropagation();
				});
				this.appFindDropdown.on("click", ":checkbox[data-app_id]", function(e) {
					e.stopPropagation();
					var selected = $(this).is(":checked");
					var catId = $(this).attr("data-parent_id");
					var appId = $(this).attr("data-app_id");
					ruleDom.appInputSelected(rule.appTypeList, catId, appId, selected);
				});
				this.appFindButton.on("click", function(){
					var findStr = rule.appFilterInput.val();
					if (findStr.length == 0) {
						getMsg($.t("msgSearchAppError"), 1, "#appFilterInput");
						return false;
					}
					var findList = "", list = rule.appList;

					Object.keys(list).forEach(function(k){
						var apps = list[k], flag = false;
						var catEl = ruleDom.catFindEleme(k, rule.catList[k]), appEl = "";
						Object.keys(apps).forEach(function(v){
							if (apps[v].indexOf(findStr) != -1) {
								flag = true;
								var isChecked = rule.appTypeList.find(":checkbox[data-app_id="+v+"]").is(":checked");
								appEl += ruleDom.appEleme("find", k, v, apps[v], isChecked);
							}
						});
						if (flag) {
							findList += catEl+appEl;
						}
					});
					if (findList.length == 0) {
						findList = $.t("lblNoData");
					}
					rule.appFindDropdown.html(findList).show();
				});
			},
			appListLoad: function() {
				rule.appList = pctrl.apps.app;
				rule.catList = pctrl.apps.cat;
				rule.catListSetDom();
				rule.appListSetDom();
			},
			ruleLoad: function(userName) {
				pctrl.user.some(function(v){
					if (v.user_name == userName) {
						rule.empty();

						var rule_data = v.rule_info;
						targetModal.elem.set = rule_data.set;
						targetModal.elem.on = rule_data.on;
						targetModal.elem.rule = rule_data.set.length;

						var user = pctrl.find(targetModal.elem.user_name);
						pctrl.ruleSize = pctrl.ruleSize - user.rule + rule_data.set.length;
						user.rule = rule_data.set.length;
						user.on = rule_data.on;

						pctrlDom.onSwitch(targetModal.elem.user_name, targetModal.elem.on);
						targetModal.onSwitch(targetModal.elem.on);

						rule.ruleParse(targetModal.elem.set);
						rule.domSet();
						return true;
					}
				});
			},
			catListSetDom: function() {
				this.appTypeList.empty();

				var typeListStr = "";

				var list = this.catList, apps = this.appList;
				Object.keys(list).forEach(function(k){
					var hasApp = (apps[k] != undefined);
					typeListStr += ruleDom.catEleme(k, list[k], hasApp);
				});

				this.appTypeList.html(typeListStr);
			},
			appListSetDom: function() {
				var _that = this, list = this.appList;
				Object.keys(list).forEach(function(k){
					var str = "";
					Object.keys(list[k]).forEach(function(v){
						str += ruleDom.appEleme("app", k, v, list[k][v]);
					});
					_that.appTypeList.find("#cat_ul_"+k).append(str);
				});
			},
			ruleParse: function(set){
				this.appIdlication = {};
				this.keywordlication = [];
				this.catIdlication = [];
				for (var i=0,len=set.length; i<len; i++) {
					var arr = set[i].split(";");
					if (arr[0] == '0') {
						if (arr.length != 2) {
							continue;
						}
						this.catIdlication.push(arr[1]);
					} else if (arr[0] == '1') {
						if (arr.length != 2) {
							continue;
						}
						this.keywordlication.push(arr[1]);
					} else if (arr[0] == '4') {
						continue;
					} else if (arr[0] == '5') {
						if (arr.length != 3) {
							continue;
						}
						if (!isNaN(Number(arr[1])) && !isNaN(Number(arr[2]))) {
							if (!(this.appIdlication.hasOwnProperty(arr[2]))) {
								this.appIdlication[arr[2]] = [];
							}
							this.appIdlication[arr[2]].push(arr[1]);
						}
					}
				}
			},
			domEmpty: function () {
				this.appTypeList.find(":checkbox").prop("checked", false);
				this.appFindDropdown.find(":checkbox").prop("checked", false);
				this.keywordList.empty();
				this.pKeyword.val("");
			},
			empty: function() {
				this.appIdlication = {};
				this.keywordlication = [];
				this.catIdlication = [];
				this.domEmpty();
			},
			domSet: function() {
				this.domEmpty();
				this.catIdlication.forEach(function(catId){
					if (rule.appList[catId] != undefined) {
						rule.appTypeList.find('input[data-parent_id="' + catId + '"]').prop("checked", true);
					}
					ruleDom.catInputSelected(rule.appTypeList, catId);
				});

				var apps = this.appIdlication;
				Object.keys(apps).forEach(function(catId){
					apps[catId].forEach(function(appId){
						ruleDom.appInputSelected(rule.appTypeList, catId, appId, true);
					});
				});

				this.keywordlication.forEach(function(keyword){
					appendNowEle(rule.keywordList, keyword);
				});
			},
			domGet:function() {
				var set = [], cats = [];
				this.appTypeList.find(':checkbox[data-cat_id]:checked').each(function () {
					var catId = $(this).attr("data-cat_id");
					var more = $(this).attr("data-more");
					if (!more || rule.appTypeList.find(':checkbox[data-parent_id="' + catId +'"]:checked').length === Object.keys(rule.appList[catId]).length) {
						set.push("0;" + catId);
						cats.push(catId);
					}
				});

				this.appTypeList.find(':checkbox[data-app_id]:checked').each(function (){
					var catId = $(this).attr("data-parent_id");
					if (cats.indexOf(catId) !== -1) {
						return;
					}
					var appId = $(this).attr("data-app_id");
					var str = "5;"+appId+";"+catId;
					set.push(str);
				});

				this.keywordList.children().each(function(){
					var str = $(this).children("span:first").text();
					if (str.length > 64) {
						return false;
					}
					set.push("1;" + str);
				});

				return set;
			}
		};

		var device = {
			init: function(modal) {
				this.macList = modal.find("#macList");
				this.pUserMAC = modal.find("#pUserMAC");
				this.addMAC = modal.find("#addMAC");
			},
			empty: function() {
				this.macList.empty();
				this.pUserMAC.val("");
			},
			domSet: function (mac) {
				this.empty();
				mac.forEach(function(item){
					appendNowEle(device.macList, item);
				});
			},
			domGet: function () {
				var mac = [];
				this.macList.children().each(function(){
					mac.push($(this).children("span:first").text());
				});
				return mac;
			},
			load: function(userName) {
				pctrl.user.some(function(v){
					if (v.user_name == userName) {
						var device_data = v.device_info;
						targetModal.elem.mac = device_data.mac;
						targetModal.elem.on = device_data.on;
						targetModal.elem.device = device_data.mac.length;

						var user = pctrl.find(targetModal.elem.user_name);
						pctrl.deviceSize = pctrl.deviceSize - user.device + device_data.mac.length;
						user.device = device_data.mac.length;
						user.on = device_data.on;

						pctrlDom.onSwitch(targetModal.elem.user_name, targetModal.elem.on);
						targetModal.onSwitch(targetModal.elem.on);

						device.domSet(targetModal.elem.mac);
						return true;
					}
				});
			}
		}

		var targetModal = {
			init: function (){
				this.modal = $("#pControlModal");
				this.userArr = [];
				this.on = this.modal.find("#enableSmart");
				this.userName = this.modal.find("#pUserName");
				this.elem = {};
				this.type = "";
				this.page = "";
			},

			event: function() {
				rule.event();

				this.modal.on("show.bs.modal", function(){
					if (targetModal.type === "edit") {
						device.load(targetModal.elem.user_name);
						rule.ruleLoad(targetModal.elem.user_name);
						schedule.scheduleLoad(targetModal.elem.user_name);
					}
				});

				this.modal.find("[data-toggle='tab']").on("click", function(){
					var control = $(this).attr("aria-controls");
					if(control === "basic") {
						targetModal.page = "device";
					} else if(control === "lock") {
						targetModal.page = "rule";
					} else if(control === "schedule") {
						targetModal.page = "schedule";
					}
				});

				this.modal.find("#pControlSave").on("click", function(){
					var on = targetModal.on.val();
					var userName = targetModal.userName.val().trim();
					var mac = device.domGet();
					var set = rule.domGet();
					var time = schedule.domGet();

					if (targetModal.type == "edit") {
						pctrl.editSetSend(userName, on, mac, set, time);
					} else {
						pctrl.addSetSend(userName, on, mac, set, time);
					}
				});

				this.modal.on("click", function(e) {
					if ($(e.target).closest(rule.appFindDropdown).length || $(e.target).closest(rule.appFindButton).length) {
						return false;
					}

					rule.appFilterInput.val("");
					rule.appFindDropdown.hide();
				});

				$("#addMAC, #addKeyword").on("click", function(){
					var inputEl = $(this).parent().prev().find("input");
					var listEl = $(this).parent().parent().next();
					var thisValue = inputEl.val();
					var nowList = listEl.children(), hasSame = false;
					var type = $(this).attr("id");

					if (nowList.length) {
						nowList.each(function(){
							if (thisValue == $(this).children("span:first").text()) {
								hasSame = true;
								return false;
							}
						});
					}

					if (type == "addMAC") {
						if (!checkMAC(inputEl)) {
							return false;
						}
						if (hasSame) {
							getMsg($.t("msgMACError2"), 2, "#pUserMAC");
							return false;
						}
					} else if (type == "addKeyword") {
						if (thisValue.length > 64) {
							getMsg($.t("msgInputLengthError"), 2, "#pKeyword");
							return false;
						}
						if (!thisValue.length) {
							getMsg($.t("msgKeywordError1"), 2, "#pKeyword");
							return false;
						}
						if (hasSame) {
							getMsg($.t("msgKeywordError2"), 2, "#pKeyword");
							return false;
						}
					}

					appendNowEle(listEl, thisValue);
					inputEl.val("");
				});

				$("#addTime").on("click", function(){
					var listEl = $("#timeList");
					var thisValue = " ";
					var dateType = $("#dateType").val();
					var weekType = $("#weekType").val();
					var startHour = $("#startHour1").val();
					var startMin = $("#startMin1").val();
					var endHour = $("#endHour1").val();
					var endMin = $("#endMin1").val();
					var limitTime = dateType + "-"+ weekType +"-" + parseInt(startHour) + "-" + parseInt(startMin) + "-" + parseInt(endHour) + "-" + parseInt(endMin);

					if ($("#timeList").children("div").length >= 4) {
						getMsg($.t("msgErrorRule4"));
						return false
					}
					if (dateType != "6") {
						var sTime = startHour*60+startMin*1, eTime = endHour*60+endMin*1;
						if (sTime == eTime) {
							getMsg($.t("lblScheduleText"));
							return false;
						} else if (sTime > eTime) {
							getMsg($.t("lblScheduleText1"));
							return false;
						}
					}
					if(dateType == "4") {
						thisValue = $.t("lblScheduleWorkday")+" | " + startHour + ":" + startMin + "-" + endHour + ":" + endMin;
					} else if (dateType == "5") {
						thisValue = $.t("lblScheduleWeekend2")+" | " + startHour + ":" + startMin + "-" + endHour + ":" + endMin;
					} else if (dateType == "6") {
						thisValue = $.t("lblScheduleAllday");
					} else if (dateType == "1") {
						thisValue = $.t("lblScheduleDayall")+" | " + startHour + ":" + startMin + "-" + endHour + ":" + endMin;
					} else if (dateType == "2") {
						switch(weekType)
						{
							case "1":
								thisValue = $.t("lblScheduleMon");
								break;
							case "2":
								thisValue = $.t("lblScheduleTue");
								break;
							case "3":
								thisValue = $.t("lblScheduleWed");
								break;
							case "4":
								thisValue = $.t("lblScheduleThur");
								break;
							case "5":
								thisValue = $.t("lblScheduleFri");
								break;
							case "6":
								thisValue = $.t("lblScheduleSat");
								break;
							case "7":
								thisValue = $.t("lblScheduleSun");
								break;
						}
						thisValue = thisValue+" | " + startHour + ":" + startMin + "-" + endHour + ":" + endMin;
					}

					var pHtml = "<div><span value="+ limitTime +">"+thisValue+"</span><span class='delete'>&times;</span></div>";
					listEl.append(pHtml);
				});

				$("[id^=dateType]").on("change", function(){
					$(this).val() == 2 ? $("#weekType").parent().parent().show() : $("#weekType").parent().parent().hide();
					$(this).val() == 6 ? $("#Sometime").hide() : $("#Sometime").show();
				});

				$("#macList, #keywordList, #timeList").on("click", ".delete", function(){
					$(this).parent().remove();
				});
			},
			show: function() {
				this.modal.modal("show");
			},
			hide: function() {
				this.modal.modal("hide");
			},
			onSwitch: function(on){
				this.on.prop("checked", on == 1).val(on);
			},
			empty: function(){
				this.onSwitch(0);
				this.userName.val("");
				device.empty();
				rule.empty();
				schedule.empty();

				this.modal.find("[href='#basic']").tab("show");
			},
			addUser: function() {
				this.empty();

				this.type = "add";
				this.onSwitch(1);

				this.show();
			},
			editUser: function(user) {
				this.empty();

				this.type = "edit";
				this.page = "device";

				var elem;
				this.userArr.some(function(e){
					if (e.user_name == user.user_name) {
						elem = e;
						return true;
					}
				});
				if (elem == undefined) {
					elem = $.extend(true, {}, user);
					elem.mac = [];
					elem.time = [];
					elem.set = [];
					this.userArr.push(elem);
				}

				this.elem = elem;
				if (this.elem.mac.length <= 0) {
					device.load(this.elem.user_name);
				} else {
					device.domSet(this.elem.mac);
				}
				$("#nowUser").val(user.user_name);
				this.userName.val(user.user_name);
				this.onSwitch(user.on);
				this.show();
			},
		};

		var logModal = {
			init: function () {
				this.modal = $("#logModal");
				this.tableDom = this.modal.find("#logList .table");
				this.nPanelDom = this.modal.find("#logList");
			},
			show: function() {
				this.modal.modal("show");
			},
			hide: function() {
				this.modal.modal("hide");
			},
			empty: function(){
				this.logData = [];
				this.total = 0;
				this.tpage = 1;
				this.npage = 1;
				this.pageNum = 0;
			},
			emptyDom: function () {
				this.tableDom.find("tbody").empty();
			},
			render: function () {
				this.emptyDom();

				var pageStart = (this.npage - 1) * this.pageNum;
				var pageEnd = this.npage * this.pageNum > this.total ? this.total : this.npage * this.pageNum;
				var nowPageData = this.logData.slice(pageStart, pageEnd);

				var dom = document.createDocumentFragment();
				if (this.total > 0) {
					nowPageData.forEach(function(v, i){
						var hasSwitch = 0;
						var trEle = $("<tr></tr>");

						Object.keys(v).forEach(function(k){
							if (k != "isChecked" && k != "disSelect" && k != "disEdit" && k != "disDel") {
								if (k == "status" && v[k].indexOf("switch") != -1 && v[k].indexOf("checked") == -1) {
									hasSwitch = 1;
								}
								trEle.append("<td>"+v[k]+"</td>");
							}
						});
						dom.appendChild(trEle[0]);
					});
				} else if (this.total == 0) {
					var tdNum = this.tableDom.find("thead > tr").children("th").length;
					dom.appendChild($("<tr><td colspan="+tdNum+">"+$.t("lblNoData")+"</td></tr>")[0]);
				}

				this.tableDom.find("tbody").html(dom);
				this.nPanelDom.find(".nowPage").text(this.npage);

				this.nPanelDom.find("[data-i18n='lblTableFooter']").text($.t("lblTableFooter", {
					tPageStart: (this.total == 0) ? 0 : (pageStart + 1),
					tPageEnd: pageEnd,
					tTotal: this.total
				}));
			},
			getLog: function(userName) {
				logModal.logData = [];

				pctrl.user.some(function(v){
					if (v.user_name == userName) {
						var log_data = v.log_info;
						logModal.total = log_data.count;
						log_data.log.forEach(function(v){
							var time = new Date(v.date);
							var date = time.getFullYear()+"/"+(time.getMonth()+1).toString().padStrStart(2)+"/"+time.getDate().toString().padStrStart(2)+" "
								       +time.getHours().toString().padStrStart(2)+":"+time.getMinutes().toString().padStrStart(2)+":"
								   	   +time.getSeconds().toString().padStrStart(2);

							var ct = rule.catList[v.category_type];
							logModal.logData.push({
								"data": date,
								"mac": v.mac,
								"ct": ct,
								"domain": v.domain_name,
							});
						});
						logModal.tpage = Math.ceil(logModal.total / logModal.pageNum) || 1;
						logModal.render();
						return true;
					}
				});
			},
			showLog: function(userName) {
				this.empty();
				this.emptyDom();
				this.pageNum = this.modal.find("#logList .perPage").val() * 1;

				this.getLog(userName);

				this.show();
			},
			event: function () {
				this.nPanelDom.on("click", ".startPage, .prevPage", function(e){
					if (logModal.npage > 1) {
						logModal.npage = (e.target.className == "startPage" ? 1 : logModal.npage-1);
						logModal.render();
					} else {
						getMsg($.t("lblFirstPage"));
					}
				});

				this.nPanelDom.on("click", ".endPage, .nextPage", function(e){
					if (logModal.npage < logModal.tpage) {
						logModal.npage = (e.target.className == "endPage" ? logModal.tpage : logModal.npage+1);
						logModal.render();
					} else {
						getMsg($.t("lblLastPage"));
					}
				});

				this.nPanelDom.on("changed", ".perPage", function(e, v){
					logModal.pageNum = v;
					logModal.tpage = Math.ceil(logModal.total/logModal.pageNum);
					if (logModal.npage > logModal.tpage) {
						logModal.npage = logModal.tpage;
					}
					logModal.render();
				});
			}
		};

		var pctrl = {
			user: [],
			userMax: 0,
			userSize: 0,
			userScheduleMax: 0,
			deviceMax: 0,
			deviceSize:0,
			scheduleMax: 0,
			scheduleSize: 0,
			ruleMax: 0,
			ruleSize: 0,
			apps: {},

			load: function (info){
				pctrl.user = info.user;
				pctrl.userMax = info.user_max;
				pctrl.userSize = info.user_size;
				pctrl.userScheduleMax = info.user_schedule_max;
				pctrl.deviceMax = info.device_max;
				pctrl.deviceSize = info.device_size;
				pctrl.scheduleMax = info.schedule_max;
				pctrl.scheduleSize = info.schedule_size;
				pctrl.ruleMax = info.rule_max;
				pctrl.ruleSize = info.rule_size;
				pctrl.apps = info.app_list;
				pctrl.domSet(pctrl.user);
			},
			domSet: function(user) {
				pctrlDom.empty();
				user.forEach(function(p){
					pctrlDom.add(p.user_name, p.on);
				});
			},
			find: function (user_name) {
				var res;
				this.user.some(function(u){
					if (u.user_name == user_name) {
						res = u;
						return true;
					}
				});
				return res;
			},
			findIndex: function (user_name) {
				var res = -1;
				this.user.some(function(u, i){
					if (u.user_name == user_name) {
						res = i;
						return true;
					}
				});
				return res;
			},
			checkNum: function (type, user_name, num) {
				var user = this.find(user_name);
				if (user == undefined) {
					return false;
				}
				if (type == "device") {
					if (this.deviceSize - user.device + num > this.deviceMax) {
						return false;
					}
				} else if (type == "rule") {
					if (this.ruleSize - user.rule + num > this.ruleMax) {
						return false;
					}
				} else if (type == "schedule") {
					if (this.userScheduleMax < num) {
						return false;
					} else {
						if (this.scheduleSize - user.schedule + num > this.scheduleMax) {
							return false;
						}
					}
				} else {
					return false;
				}
				return true;
			},
			addSetSend: function(userName, on, mac, set, time) {
				if (userName.length == 0) {
					getMsg($.t("msgLoginError1"));
					return false;
				}
				if (userName.length > 32) {
					getMsg($.t("msgUnameError"));
					return false;
				}
				if (this.user.find(function(u) {
					return u.user_name == userName;
				}) != undefined) {
					getMsg($.t("msgUnameError1"));
					return false;
				}

				if (mac.length == 0) {
					getMsg("MAC " + $.t("msgAlert1"));
					return false;
				}

				if (set.length == 0) {
					getMsg($.t("lblArkBlock") + " " + $.t("msgAlert1"));
					return false;
				}

				if (time.length == 0) {
					getMsg($.t("lblTimeManage") + " " + $.t("msgAlert1"));
					return false;
				}

				if (pctrl.deviceSize + mac.length > pctrl.deviceMax) {
					getMsg($.t("msgErrorMAC"));
					return false;
				}

				if (pctrl.ruleSize + set.length > pctrl.ruleMax) {
					getMsg($.t("msgErrorApplyFilter"));
					return false;
				}

				if (time.length > pctrl.userScheduleMax || pctrl.scheduleSize + time.length > pctrl.scheduleMax) {
					getMsg($.t("msgErrorTime"));
					return false;
				}

				getMsg($.t("msgWebBlockText3"));
				targetModal.hide();
				var newUser = {
					user_name:userName,
					on: on,
					device: 0,
					schedule: 0,
					rule: 0,
					device_info: {mac: mac, on: on},
					schedule_info: {time: time, on: on},
					rule_info: {set: set, on: on},
					log_info: {count: 0, log: []}
				};
				pctrl.user.push(newUser);
				pctrl.userSize += 1;
				pctrlDom.add(userName, on);
			},

			editSetSend: function(userName, on, mac, set, time) {
				if (userName.length == 0) {
					getMsg($.t("msgLoginError1"));
					return false;
				}
				if (userName.length > 32) {
					getMsg($.t("msgUnameError"));
					return false;
				}

				if (mac.length == 0) {
					getMsg($.t("msgMACError1"));
					return false;
				}

				if (set.length == 0) {
					getMsg($.t("msgKeywordError1"));
					return false;
				}

				if (time.length == 0) {
					getMsg($.t("msgAlert1"));
					return false;
				}

				if (pctrl.deviceSize + mac.length > pctrl.deviceMax) {
					getMsg($.t("msgErrorMAC"));
					return false;
				}

				if (pctrl.ruleSize + set.length > pctrl.ruleMax) {
					getMsg($.t("msgErrorApplyFilter"));
					return false;
				}

				if (time.length > pctrl.userScheduleMax || pctrl.scheduleSize + time.length > pctrl.scheduleMax) {
					getMsg($.t("msgErrorTime"));
					return false;
				}

				pctrl.user.some(function(v){
					if (v.user_name == $("#nowUser").val()) {
						v.user_name = userName;
						v.device_info.on = on;
						v.device_info.mac = mac;
						v.rule_info.on = on;
						v.rule_info.set = set;
						v.schedule_info.on = on;
						v.schedule_info.time = time;
						return true;
					}
				});
				getMsg($.t("msgModifySuccess"));
				pctrl.domSet(pctrl.user);
			},

			delSetSend: function(user, script) {
				getMsg($.t("msgDeleteSuccess"));
				pctrl.deviceSize -= user.device;
				pctrl.ruleSize -= user.rule;
				pctrl.scheduleSize -= user.schedule;
				pctrlDom.del(user.user_name);
				var index = pctrl.user.findIndex(function(item){
					return item.user_name == user.user_name;
				});
				if (index != -1) {
					pctrl.user.splice(index, 1);
				}
			},

			event: function() {
				$("#addControlRule").on("click", function () {
					if (pctrl.userSize + 1 > pctrl.userMax || pctrl.scheduleSize + 1 > pctrl.scheduleMax
						|| pctrl.deviceSize + 1 > pctrl.deviceMax || pctrl.ruleSize + 1 > pctrl.ruleMax) {
						getMsg($.t("msgAlert5"));
						return false;
					}

					targetModal.addUser();
				});

				$("#control_list").on("click", ".deleteBtn", function () {
					var user_name = $(this).closest(".item").attr("id").slice(6);
					if (user_name == undefined) {
						return false;
					}
					var user = pctrl.find(user_name);

					pctrl.delSetSend(user, 1);
				});

				$("#control_list").on("click", ".editBtn", function () {
					var user_name = $(this).closest(".item").attr("id").slice(6);
					if (user_name == undefined) {
						return false;
					}
					var user = pctrl.find(user_name);

					targetModal.editUser(user);
				});

				$("#control_list").on("click", ".checkBtn", function () {
					var user_name = $(this).closest(".item").attr("id").slice(6);
					if (user_name == undefined) {
						return false;
					}

					logModal.showLog(user_name);
				});
			}
		};

		ajax({
			url: "ai.json",
			success: function (data) {
				if (data.error == 0) {
					targetModal.init();
					device.init(targetModal.modal);
					rule.init(targetModal.modal);
					schedule.init(targetModal.modal);
					logModal.init();

					pctrl.load(data.pControl_info);
					rule.appListLoad();
					pctrl.event();
					targetModal.event();
					logModal.event();
				} else {
					locationUrl(data.error);
				}
			}
		});
	});
</script>
