<div class="page-content row">
    <div class="col-xs-9 content">
        <div class="form-group" data-i18n="lblWakeOneLan"></div>
        <div id="wolTable" style="height: 250px; overflow-y: auto;">
            <table class="table table-condensed table-hover">
                <thead style="position: sticky; top:0;">
                    <tr>
                        <th class="col-xs-1"><input type="checkbox" id="wolSelectAll"></th>
                        <th class="col-xs-2" data-i18n="lblDescribe"></th>
                        <th class="col-xs-3" data-i18n="lblMACAddressName"></th>
                        <th class="col-xs-1" data-i18n="lblWolHour"></th>
                        <th class="col-xs-1" data-i18n="lblWolMinute"></th>
                        <th class="col-xs-4" data-i18n="lblReapte"></th>
                    </tr>
                </thead>
                <tbody id="wolTbody"></tbody>
            </table>
        </div>
        <hr class="depart-line">
        <div class="row">
            <div class="col-xs-4 col-xs-offset-4">
                <button type="button" class="btn btn-primary theme-bg-color" id="wolAdd" data-i18n="btnAddExtender"></button>
            </div>
            <div class="col-xs-4">
                <button type="button" class="btn btn-primary theme-bg-color"id="wolDel" data-i18n="btnDelete"></button>
            </div>
        </div>
    </div>
    <div class="col-xs-3 help">
        <h4 data-i18n="lblHelp"></h4>

        <h5 data-i18n="lblWakeOneLan"></h5>
        <p data-i18n="msgHelpWakeOneLan"></p>
    </div>
</div>

<div class="modal fade" id="wolModal">
    <div class="modal-dialog">
        <div class="modal-content theme-border-color">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                <h5 class="modal-title text-center" data-i18n="lblWakeUpConfig"></h5>
            </div>
            <div class="modal-body">
                <div id="wolForm">
                    <form class="form-horizontal" role="form">
                        <div class="form-group row">
                            <label for="uname" class="col-md-2 col-xs-2 control-label" data-i18n="lblDescribe"></label>
                            <div class="col-md-6 col-xs-6 col-md-push-4 col-xs-push-4">
                                <input type="text" class="form-control" id="uname">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="wolMAC" class="col-md-2 col-xs-2 control-label" data-i18n="lblMACAddressName"></label>
                            <div class="col-md-6 col-xs-6 col-md-push-4 col-xs-push-4">
                                <input type="text" class="form-control" id="wolMAC" placeholder="FF:FF:FF:FF:FF:FF">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="woltime" class="col-md-2 col-xs-2 control-label" data-i18n="lblTimeSeting"></label>
                            <div class="col-md-6 col-xs-6 col-md-push-4 col-xs-push-4">
                                <div class="row">
                                    <div class="col-md-6 col-xs-6">
                                        <div class="input-group" style="padding-left: 5px;">
                                            <input type="text" class="form-control text-center" id="wolHour" placeholder="00">
                                            <span class="input-group-addon" data-i18n="lblWolHour"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-xs-6">
                                        <div class="input-group"  style="padding-left: 5px;">
                                            <input type="text" class="form-control text-center" id="wolMinute" placeholder="00">
                                            <span class="input-group-addon" data-i18n="lblWolMinute"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <label for="wolweek" class="col-md-3 col-xs-3 control-label" data-i18n="lblRebootTime"></label>
                            <div class="col-md-9 col-xs-9 text-right">
                                <div id="wolWeeks">
                                    <button id="wake_week7" type="button" class="selectDate" data-i18n="tTimingRebootSun"></button>
                                    <button id="wake_week1" type="button" class="selectDate" data-i18n="tTimingRebootMon"></button>
                                    <button id="wake_week2" type="button" class="selectDate" data-i18n="tTimingRebootTue"></button>
                                    <button id="wake_week3" type="button" class="selectDate" data-i18n="tTimingRebootWed"></button>
                                    <button id="wake_week4" type="button" class="selectDate" data-i18n="tTimingRebootThur"></button>
                                    <button id="wake_week5" type="button" class="selectDate" data-i18n="tTimingRebootFri"></button>
                                    <button id="wake_week6" type="button" class="selectDate" data-i18n="tTimingRebootSat"></button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-md-4 col-xs-4 col-md-offset-2 col-xs-offset-2">
                        <button type="button" class="btn btn-primary theme-bg-color" id="wolWakeUp" data-i18n="btnWakeUp"></button>
                    </div>
                    <div class="col-md-4 col-xs-4">
                        <button type="button" class="btn btn-primary theme-bg-color" id="wolSave" data-i18n="btnSaveName"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    try{
        $;
    }catch(e){
        window.sessionStorage.setItem("page", "/setting/wakeonelan.html");
        window.location.replace("./index.html");
    }

    $(document).ready(function(){
        getWakeOneLan();

        $("#wolAdd").click(function() {
            let modal = $("#wolModal");
            modal.find("input, textarea").val("");
            modal.find("button").removeClass("selected");
            modal.modal("show");

            $("#uname").prop("disabled", false);
        });

        $("#wolModal .selectDate").on("click", function(){
            $(this).hasClass("selected") ? $(this).removeClass("selected") : $(this).addClass("selected");
        });

        $("#wolSelectAll").on("click", function() {
            $("#wolTbody input[type='checkbox']").prop("checked", $(this).is("checked"));
        });

        $("#wolTbody").on("click", "tr", function(e) {
            if ($(e.target).is("input[type='checkbox']")) {
                return;
            }

            let uname = $(this).find("td:nth-child(2)").text();
            let macAddress = $(this).find("td:nth-child(3)").text();
            let hour = $(this).find("td:nth-child(4)").text();
            let minute = $(this).find("td:nth-child(5)").text();
            let wake_weeks = $(this).find("td:nth-child(6)").attr("value");
            $("#uname").val(uname).prop("disabled", true);
            $("#wolMAC").val(macAddress);
            $("#wolHour").val(hour);
            $("#wolMinute").val(minute);
            wake_weeks.split("").forEach(function(v, i){
                if (v == 1) {
                    $("#wake_week"+(i==0?7:i)).addClass("selected");
                }
            });
            $("#wolModal").modal("show");
        });

        $("#wolSave").on("click", function(){
            let uname = $("#uname").val().trim();
            let mac = $("#wolMAC").val().trim();
            let hour = $("#wolHour").val().trim();
            let minute = $("#wolMinute").val().trim();
            let weeks = "";
            $("#wolWeeks").find("button").each(function() {
                weeks += $(this).hasClass("selected") ? "1" : "0";
            });
            if (weeks === "0000000") {
                weeks = "1111111";
            }
            if ($("#uname").is(":disabled")) {
                if (is_Mac(mac) && is_wolHour(hour) && is_wolMinute(minute)) {
                    let result = wolWeeks(weeks);
                    $("#wolTbody tr").each(function() {
                        if ($(this).find("td:nth-child(2)").text().trim() == uname) {
                            $(this).find("td:nth-child(3)").text(mac);
                            $(this).find("td:nth-child(4)").text(hour);
                            $(this).find("td:nth-child(5)").text(minute);
                            $(this).find("td:nth-child(6)").text(result).attr("value", weeks);
                            return false;
                        }
                    });
                    $("#wolModal").modal("hide");
                    getMsg($.t("msgModifySuccess"));
                }
            } else {
                if ($(this).attr("data-i18n") == "btnSaveName") {
                    if ($("#wolTbody tr").length >= 50) {
                        getMsg($.t("msgRulesNumError"));
                        return 0;
                    }

                    if (is_wolUname(uname) && checkDescription(uname) && is_Mac(mac)
                        && is_wolHour(hour) && is_wolMinute(minute)) {
                        wolRowAppend(uname, mac, hour, minute, weeks);
                        $("#wolModal").modal("hide");
                        getMsg($.t("msgWebBlockText3"));
                    }
                }
            }
        });

        $("#wolDel").click(function() {
            let selectedRowsData = [];
            let hasSelectedRows = false;
            $("#wolTbody").find(":checked").each(function(){
                hasSelectedRows = true;
                selectedRowsData.push($(this).parents("tr").prevAll().length);
            });
            $("#wolSelectAll").prop("checked", false);
            if (!hasSelectedRows || selectedRowsData.length === 0) {
                getMsg($.t("msgNoRulesSelected"));
            } else {
                startLoading(4000, $.t("lblTouchLinkDel"));
                selectedRowsData.reverse().forEach(function(v){
                    $("#wolTbody").find("tr:eq("+v+")").remove();
                });
            }
        });

        $("#wolWakeUp").on("click", function(){
            let mac = $("#wolMAC").val().trim();
            if (is_Mac(mac)) {
                $("#wolModal").modal("hide");
                getMsg($.t("msgWakeUpSuccess"));
            }
        });

        function is_wolUname(uname) {
            if (!SsidLenCheck(uname, 32)) {
                getMsg($.t("msgUnameError"), 2, "#uname");
                return false;
            }

            return true;
        }

        function is_wolHour(str) {
            if (str.length > 0) {
                if (/^\d+$/.test(str)) {
                    let num = parseInt(str, 10);
                    if (Number.isInteger(num) && num >= 0 && num <= 23) {
                        return true;
                    }
                }
            }

            getMsg($.t("msgHourError"), 2, "#wolHour");
            return false;
        }

        function is_wolMinute(str) {
            if (str.length > 0) {
                if (/^\d+$/.test(str)) {
                    let num = parseInt(str, 10);
                    if (Number.isInteger(num) && num >= 0 && num <= 59) {
                        return true;
                    }
                }
            }

            getMsg($.t("msgMinuteError"), 2, "#wolMinute");
            return false;
        }

        function is_Mac(mac) {
            var len = mac.length;
            if (len == 0) {
                getMsg($.t("msgMacError1"), 2, "#wolMAC");
                return false;
            } else if (len != 17) {
                getMsg($.t("msgMacError2"), 2, "#wolMAC");
                return false;
            }

            for (var i=0; i<mac.length; i++) {
                if ((i%3) == 2) {
                    if (mac.charAt(i) == ":") continue;
                } else {
                    if ((mac.charAt(i) >= "0" && mac.charAt(i) <= "9") ||
                        (mac.charAt(i) >= "a" && mac.charAt(i) <= "f") ||
                        (mac.charAt(i) >= "A" && mac.charAt(i) <= "F"))
                        continue;
                }
                getMsg($.t("msgMacError2"), 2, "#wolMAC");
                return false;
            }

            return true;
        }

        function checkDescription(str) {
            let match = true;
            $("#wolTable tbody td:nth-child(2)").each(function() {
                if ($(this).text().trim() === str) {
                    match = false;
                }
            });

            if (match == false) {
                getMsg($.t("msgUnameError1"), 2, "#uname");
            }

            return match;
        }

        function wolWeeks(weeks) {
            const days = ["tTimingRebootSun", "tTimingRebootMon", "tTimingRebootTue", "tTimingRebootWed", "tTimingRebootThur", "tTimingRebootFri", "tTimingRebootSat"];
            let result = "";
            for (let i = 0; i < weeks.length && i < 7; i++) {
                if (weeks.charAt(i) === "1") {
                    result += $.t(days[i]) + " ";
                }
            }
            return result;
        }

        function wolRowAppend(uname, mac, hour, minute, weeks) {
            let result = wolWeeks(weeks);
            $("#wolTbody").append(`<tr>
                <td><input type="checkbox"></td>
                <td>${uname}</td><td>${mac}</td><td>${hour}</td><td>${minute}</td>
                <td value="${weeks}">${result}</td></tr>`);
        }

        function getWakeOneLan(){
            ajax({
                url: "network.json",
                beforeSend: function(){
                    $("#wolTbody").empty();
                },
                success: function(data) {
                    if (data.error == 0) {
                        data.wake_rules.forEach(function(v){
                            if (v.uname) {
                                wolRowAppend(v.uname, v.mac, v.hour, v.minute, v.weeks);
                            }
                        });
                    } else {
                        locationUrl(data.error);
                    }
                }
            });
        }
    });
</script>
