<div class="main terminal">
    <div class="form-group">
        <ul class="nav nav-tabs theme-border-color active-bg" role="tablist">
            <li role="presentation" class="active">
                <a href="#onlineList" aria-controls="onlineList" role="tab"
                    data-toggle="tab" data-i18n="lblTerminalOnline"></a>
            </li>
            <li role="presentation">
                <a href="#offlineList" aria-controls="offlineList" role="tab"
                    data-toggle="tab" data-i18n="lblTerminalOffline"></a>
            </li>
            <div class="pull-right" data-toggle="modal" data-target="#helpModal">
                <img src="../img/help.png" width="22px">&nbsp;<span data-i18n="lblHelp"></span>
            </div>
        </ul>
    </div>

    <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="onlineList">
            <table class="table">
                <thead>
                    <tr>
                        <th data-i18n="lblDeviceName"></th>
                        <th data-i18n="lblType"></th>
                        <th data-i18n="lblCurrentSpeed"></th>
                        <th><span data-i18n="lblSpeedLimit"></span>(KB)</th>
                        <th data-i18n="lblbannetwork"></th>
                    </tr>
                </thead>
                <tbody id="online_devices">
                    <tr><td colspan="5"><img src="../public/static/layer/skin/default/loading-2.gif" width="20px"></td></tr>
                </tbody>
            </table>
        </div>
        <div role="tabpanel" class="tab-pane" id="offlineList">
            <table class="table">
                <thead>
                    <tr>
                        <th data-i18n="lblDeviceName"></th>
                        <th data-i18n="lblMACAddressName"></th>
                        <th><span data-i18n="lblSpeedLimit"></span>(KB)</th>
                        <th data-i18n="lblRmTerminal"></th>
                    </tr>
                </thead>
                <tbody id="offline_devices"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade help-modal" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="helpModal" data-dismiss="modal">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header theme-border-color">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="helpModalLabel" data-i18n="lblHelp"></h4>
            </div>
            <div class="modal-body">
                <div class="item">
                    <div class="text" data-i18n="msgTerminal"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    try{
        $;
    }catch(e){
        window.sessionStorage.setItem("page", "terminal.html");
        window.location.replace("./index.html");
    }
    $(document).ready(function(){
        var imgHtml = "<img class='editName' src='../img/edit.png' width='18px' />";

        getTerminalList();

        // 点击编辑按钮
        $("#online_devices, #offline_devices").on("click", ".editName", function(e){
            var thisTd = $(this).parent();
            var nowName = $(this).prev().text();
            thisTd.html("<input type='text' class='form-control changeName' data-old='"+nowName+"' value='"+nowName+"'>");
            thisTd.find(".changeName").focus();
        });
        // 编辑当前节点的名称
        $("#online_devices, #offline_devices").on("blur", ".changeName", function(e){
            var thisTd = $(this).parent();
            var newName = $(this).val();
            var oldName = $(this).attr("data-old");

            if (oldName == newName) {
                thisTd.html(oldName+imgHtml);
                return false;
            } else if (!newName.length) {
                getMsg($.t("msgTerminalText1"), 2, this);
                return false;
            } else if (!SsidLenCheck(newName, 31)) {
                getMsg($.t("msgTerminalText2"), 2, this);
                return false;
            } else if (!checkSpecialCharacter2(newName)) {
                getMsg($.t("msgTerminalText3"), 2, this);
                return false;
            }
            getMsg($.t("msgterminalText5"));
            thisTd.html(newName+imgHtml);
        });
        // 对设备进行限速
        $("#online_devices, #offline_devices").on("change", ".sLimit", function() {
            $(this).next().attr("readonly", $(this).val() == 0).val($(this).val() == 0 ? $.t("lblunlimited") : 0).focus();
        });
        $("#online_devices, #offline_devices").on("blur", ".usLimit, .dsLimit", function() {
            var us_val, ds_val;
            var now_val = $(this).val() == $.t("lblunlimited") ? 0 : $(this).val();
            var old_val = $(this).attr("data-old");

            if (now_val != old_val) {
                if (!checkStrnum(now_val) || now_val*1 < 0 || now_val*1 > 65535) {
                    $(this).val(0);
                    getMsg($.t("msgSpeedError"));
                    return false;
                }
                if ($(this).hasClass("usLimit")) {
                    us_val = now_val;
                    ds_val = $(this).parents("td").find(".dsLimit").val();
                    ds_val = ds_val == $.t("lblunlimited") ? 0 : ds_val;
                } else {
                    ds_val = now_val;
                    us_val = $(this).parents("td").find(".usLimit").val();
                    us_val = us_val == $.t("lblunlimited") ? 0 : us_val;
                }
                getMsg($.t("msgSpeed"));
            }
        });
        // 禁止在线设备上网
        $("#online_devices").on("change", ".switch-checkbox", function() {
            getMsg($.t("msgterminalText5"));
        });
        // 删除离线设备
        $("#offline_devices").on("click", ".removeThis", function() {
            var thisTr = $(this).parents("tr");
            getMsg($.t("msgTerminalText4"));
            thisTr.remove();
        });

        function getTerminalList() {
            $("#online_devices").html("<tr><td colspan='5'><img src='../public/static/layer/skin/default/loading-2.gif' width='20px'></td></tr>");
            ajax({
                url: "terminal.json",
                success: function(data){
                    if (data.error == 0) {
                        var onlineDeviceHtml = "", offlineDeviceHtml = "";
                        data.terminals.forEach(function(t, i) {
                            var flag = t.flag, speed, up_speed, device_name = t.name;
                            if (device_name == "" || device_name == "*") {
                                device_name = "Other";
                            }
                            var switch_flag = flag.charCodeAt(2) == 70 ? "switch open" : "switch";
                            var wifi_flag = flag.charCodeAt(9) == 84 ? "WIFI" : "LAN";
                            var ls_down_speed = t.ls, ls_up_speed = t.ls_up;

                            var limitSpeedHtml = "<td>"+"<div class='limit'>"+$.t("lblupl")+"<div class='limit_box'>\
                                                <select class='form-control sLimit'>\
                                                <option value='0'"+(ls_up_speed==0 ? " selected>" : ">")+$.t("lblunlimited")+"</option>\
                                                <option value='1'"+(ls_up_speed!=0 ? " selected>" : ">")+$.t("btnSelfDefine")+"</option></select>\
                                                <input type='text' class='form-control usLimit' data-old='"+ls_up_speed
                                                +"' value='"+(ls_up_speed==0 ? $.t("lblunlimited")+"' readonly>" : ls_up_speed+"'>")+"</div><br>\
                                                "+$.t("lbldownl")+"<div class='limit_box'>\
                                                <select class='form-control sLimit'>\
                                                <option value='0'"+(ls_down_speed==0 ? " selected>" : ">")+$.t("lblunlimited")+"</option>\
                                                <option value='1'"+(ls_down_speed!=0 ? " selected>" : ">")+$.t("btnSelfDefine")+"</option></select>\
                                                <input type='text' class='form-control dsLimit' data-old='"+ls_down_speed
                                                +"' value='"+(ls_down_speed==0 ? $.t("lblunlimited")+"' readonly>" : ls_down_speed+"'>")+"</div></div></td>";

                            if (flag.charCodeAt(1) == 84) { // T
                                var wireless = 1, lblwirless;
                                if (t.band == 0) {
                                    wireless = 0;
                                    lblwirless = $.t("lblwireless2g");
                                } else if (t.band==1) {
                                    wireless = 0;
                                    lblwirless = $.t("lblwireless5g");
                                } else if (t.band == 2) {
                                    wireless = 1;
                                    lblwirless = $.t("lblwirelesslan");
                                } else {
                                    wireless = 0;
                                    lblwirless = $.t("lblwireless");
                                }
                                speed = t.speed > 1024 ? (t.speed / 1024).toFixed(2) + "MB/S" : t.speed + "KB/S";
                                up_speed = t.up_speed > 1024 ? (t.up_speed / 1024).toFixed(2) + "MB/S" : t.up_speed + "KB/S";

                                onlineDeviceHtml += "<tr><td><div><span>"+htmlEscape(device_name)+"</span>"+imgHtml+"</div>\
                                                    <div>"+$.t("lblAdd")+t.ip+"</div><div class='mac'>"+$.t("lblMACAdd")+t.mac+"</div>\
                                                    <div>"+$.t("lbltime")+formatSeconds(t.ontime)+"</div></td>";
                                if (wireless == 1) {
                                    onlineDeviceHtml += "<td><img src='../img/ter_lan.png' ><div>"+lblwirless+"</div></td>";
                                } else {
                                    if (t.rssi >= 75) {
                                        onlineDeviceHtml += "<td><img src='../img/ter_wifi.png' ><div>"+lblwirless+"</div><div>"+t.rssi+"%</div></td>";
                                    } else if (t.rssi >= 50) {
                                        onlineDeviceHtml += "<td><img src='../img/ter_wifi_middle.png' ><div>"+lblwirless+"</div><div>"+t.rssi+"%</div></td>";
                                    } else if (t.rssi >= 25) {
                                        onlineDeviceHtml += "<td><img src='../img/ter_wifi_low.png' ><div>"+lblwirless+"</div><div>"+t.rssi+"%</div></td>";
                                    } else {
                                        onlineDeviceHtml += "<td><img src='../img/ter_wifi.png' ><div>"+lblwirless+"</div></td>";
                                    }
                                }
                                onlineDeviceHtml += "<td><img src='../img/upload.png' >"+up_speed+"<br><img src='../img/download.png' >"+speed+"</td>";
                                onlineDeviceHtml += limitSpeedHtml;
                                onlineDeviceHtml += "<td><div class='switch'>\
                                                    <input class='switch-checkbox hidden' id='disableNet_"+i+"' type='checkbox'"+(t.net_index ? "checked" : "")+">\
                                                    <label class='switch-label' for='disableNet_"+i+"'>\
                                                    <span class='switch-inner'></span></label></div></td></tr>";
                            } else if (flag.charCodeAt(1) == 70) {  // F
                                offlineDeviceHtml += "<tr><td>"+htmlEscape(device_name)+imgHtml+"</td>\
                                                    <td class='mac'>"+t.mac+"</td>"+limitSpeedHtml+"\
                                                    <td><img class='removeThis' src='../img/delete.png' width='22px'></td></tr>";
                            }
                        });

                        $("#online_devices").html(onlineDeviceHtml);
                        $("#offline_devices").html(offlineDeviceHtml);
                    } else {
                        locationUrl(data.error);
                    }
                }
            });
        }
    });
</script>