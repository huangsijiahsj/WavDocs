<div class="page-content row">
    <div class="col-xs-9 content">
        <div class="form-group row">
            <label class="col-xs-8 control-label" data-i18n="lblOpenVPN_Client"></label>
            <div class="col-xs-4 text-right">
                <div class="switch">
                    <input class="switch-checkbox hidden" id="EnableVpnCli" type="checkbox">
                    <label class="switch-label" for="EnableVpnCli">
                        <span class="switch-inner"></span>
                    </label>
                </div>
            </div>
        </div>
        <div id="vpn_client" class="off">
            <div class="form-group row">
                <label class="col-xs-8 control-label" data-i18n="lblOpenVPN_Pwd_En"></label>
                <div class="col-xs-4 text-right">
                    <div class="switch">
                        <input class="switch-checkbox hidden" id="ovpn_pwd_en" type="checkbox">
                        <label class="switch-label" for="ovpn_pwd_en">
                            <span class="switch-inner"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div id="openvpn_pwd" class="off">
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblUserName"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="cli_usr_name">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblPassWord"></label>
                    <div class="col-xs-5">
                        <input type="password" class="form-control" id="cli_usr_passwd">
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-xs-7 control-label" data-i18n="lblStatus"></label>
                <div class="col-xs-5 text-right" id="status" data-i18n="lblOffline"></div>
            </div>
            <div class="form-group row">
                <label class="col-xs-4 control-label" data-i18n="lblOpenVPN_File"></label>
                <div class="col-xs-4">
                    <input type="text" class="form-control selectFile" id="ovpnChooseFile" data-i18n="[placeholder]lblChooseOvpnFile" readonly />
                    <input type="file" class="hidden" id="ovpnSelectedFile" />
                    <img src="../img/folder.png" class="selectFile" />
                </div>
            </div>
            <div class="form-group row">
                <div class="col-xs-4 col-xs-offset-4">
                    <button class="btn btn-primary theme-bg-color" id="OvpnFileBtn" data-i18n="lblUpload"></button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-4 col-xs-offset-4">
                <button class="btn btn-primary theme-bg-color" id="openvpn_cli_save" data-i18n="lblSave"></button>
            </div>
            <div class="col-xs-4 text-right off" style="font-size: 16px;">
                <a id="openvpn_downloadlog" data-i18n="lblBackupOvpnLog" download="ovpn_log" href="../data/ovpn"></a>
            </div>
        </div>
    </div>
    <div class="col-xs-3 help">
        <h4 data-i18n="lblHelp"></h4>
        <p data-i18n="lblVpnHelpText"></p>
    </div>
</div>

<script>
    try{
        $;
    }catch(e){
        window.sessionStorage.setItem("page", "/setting/openvpn_client.html");
        window.location.replace("./index.html");
    }

    $(document).ready(function(){
        var upload_flag = 0, enable_server = 0, enable_client = 0;

        getOpenVpn();

        $("#ovpn_pwd_en").on("change", function(){
            $(this).is(":checked") ? $("#openvpn_pwd").show() : $("#openvpn_pwd").hide();
        });
        $("#EnableVpnCli").on("change", function(){
            if (enable_server == 0) {
                $("#openvpn_downloadlog").parent().hide();
                $(this).is(":checked") ? $("#vpn_client").show() : $("#vpn_client").hide();
            } else {
                $(this).prop("checked", false).val(0);
                getMsg($.t("msgVpnEnableError"));
            }
        });
        $("#OvpnFileBtn").on("click", function(){
            var mydata = document.getElementById("ovpnSelectedFile").files[0];
            if (mydata == undefined) {
                getMsg($.t("msgBrowseFilerror1"));
                return;
            }
            //File format restriction
            var name = document.getElementById("ovpnChooseFile").value;
            var filetype = name.lastIndexOf(".");
            if (name.substr(filetype) != ".ovpn") {
                getMsg($.t("msgBrowseFilerror3"));
                return;
            }
            startLoading(3000, $.t("msgUploading"));
            upload_flag = 1;
        });

        $("#openvpn_cli_save").on("click", function(){
            var OVPN_Pwd_En = $("#ovpn_pwd_en").val();
            var cli_usr_name = $("#cli_usr_name").val();
            var cli_usr_passwd = $("#cli_usr_passwd").val();
            var enable = $("#EnableVpnCli").val();
            var mydata = document.getElementById("ovpnSelectedFile").files[0];
            if (enable == 0) {
                startLoading(2000, $.t("btnSaveName"));
                return ;
            }
            if (mydata == undefined || upload_flag == 0) {
                getMsg($.t("msgBrowseFilerror2"));
                return;
            }
            if (OVPN_Pwd_En == 1) {
                if (cli_usr_name == "") {
                    getMsg($.t("msgIpNone"), 1, "#cli_usr_name");
                    return false;
                } else if (cli_usr_name.indexOf(" ") !== -1) {
                    getMsg($.t("msgIPv6SpaceError"), 1, "#cli_usr_name");
                    return false;
                } else if (!checkSpecialCharacter(cli_usr_name)) {
                    getMsg($.t("msgLoginPasswordText8"), 1, "#cli_usr_name");
                    return false;
                } else if (!SsidLenCheck(cli_usr_name, 64)) {
                    getMsg($.t("msgInputLengthError"), 1, "#cli_usr_name");
                    return false;
                } else if (/\s/.test(cli_usr_name)) {
                    getMsg($.t("msgIPv6SpaceError"), 1, "#cli_usr_name");
                    return false;
                }
                if (cli_usr_passwd == "") {
                    getMsg($.t("msgIpNone"), 1, "#cli_usr_passwd");
                    return false;
                } else if (cli_usr_passwd.indexOf(" ") !== -1) {
                    getMsg($.t("msgIPv6SpaceError"), 1, "#cli_usr_passwd");
                    return false;
                } else if (!checkSpecialCharacter(cli_usr_passwd)) {
                    getMsg($.t("msgLoginPasswordText8"), 1, "#cli_usr_passwd");
                    return false;
                } else if (!SsidLenCheck(cli_usr_passwd, 64)) {
                    getMsg($.t("msgInputLengthError"), 1, "#cli_usr_passwd");
                    return false;
                } else if (/\s/.test(cli_usr_passwd)) {
                    getMsg($.t("msgIPv6SpaceError"), 1, "#cli_usr_passwd");
                    return false;
                }
            }
            $("#ovpnSelectedFile, #ovpnChooseFile").val("");
            // upload_flag=0;

            $("#status").text($.t("lblConnecting"));
            startLoading(2000, $.t("btnSaveName"));
        });

        //openvpn_cli get
        function getOpenVpn(){
            ajax({
                url: "vpn.json",
                success: function(data){
                    if (data.error == 0) {
                        var client = data.ovpn_client;
                        enable_client = client.enable_client;
                        enable_server = client.enable_server;
                        if (client.ovpn_enable == 1) {
                            $("#status").text($.t(client.status == 1 ? "lblOnline" : "lblUnconnected"));
                            $("#ovpn_pwd_en").prop("checked", client.sel_pwd_val == 1).change();
                            if (client.sel_pwd_val == 1) {
                                $("#cli_usr_name").val(client.usr_name);
                                $("#cli_usr_passwd").val(client.usr_passwd);
                            }
                            $("#openvpn_downloadlog").parent().show();
                        }
                        $("#EnableVpnCli").prop("checked", client.ovpn_enable == 1).change();
                    } else {
                        locationUrl(data.error);
                    }
                }
            });
        }
    });
</script>
