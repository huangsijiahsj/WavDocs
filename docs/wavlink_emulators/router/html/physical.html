<div class="page-content row">
    <div class="col-xs-9 content" id="physical">
        <div class="form-group row" id="phyStart">
            <div class="col-xs-4 text-right">
                <img src="../img/physical.png" width="70px">
            </div>
            <div class="col-xs-6 text-left">
                <label class="form-group" data-i18n="lblPhysicalExplain"></label>
                <button type="button" class="btn btn-primary theme-bg-color" id="phyDetectBtn" data-i18n="lblPhyStartDetect"></button>
            </div>
        </div>
        <div class="off" id="phyDetecting">
            <div class="form-group row">
                <div class="col-xs-4 text-right">
                    <img src="../img/loading.gif" width="70px">
                </div>
                <div class="col-xs-7 text-left">
                    <span data-i18n="lblPhyDetecting"></span>
                    <span id="phyTime">0%</span>
                </div>
            </div>
        </div>
        <div class="off" id="phyComplete">
            <div class="form-group row">
                <div class="col-xs-4 text-right">
                    <img src="../img/detected.png" width="70px">
                </div>
                <div class="col-xs-6 text-left">
                    <label data-i18n="lblPhyDetectComplete"></label>
                    <button type="button" class="btn btn-primary theme-bg-color" id="phyCompleteBtn" data-i18n="btnPhyRepair"></button>
                </div>
            </div>
        </div>

        <div class="up text-center">
            <span data-i18n="lblWanSta4"></span>
            <span data-i18n="lblPhyWanExplain"></span>
            <div>
                <span id="phyDetectText_0" data-i18n="lblPhysicalDetect"></span>
                <img src="../img/success.png" id="phyDetectImg_0" class="off">
            </div>
        </div>
        <div class="down" id="phyWan">
            <div>
                <span data-i18n="lblPhyWanLink"></span>
                <div>
                    <span data-i18n="lblPhyWanDisconnect" id="phyWanlink_lbl"></span>
                    <img src="../img/success.png" id="phyWanlink_img" class="off">
                </div>
            </div>
            <div>
                <span data-i18n="lblPhyWanIp"></span>
                <div>
                    <span data-i18n="lblPhyWanDisconnect" id="phyWanip_lbl"></span>
                    <img src="../img/success.png" id="phyWanip_img" class="off">
                </div>
            </div>
            <div>
                <span data-i18n="lblPhyWanPortSpeed"></span>
                <div>
                    <span data-i18n="lblPhyWanDisconnect" id="phyWanspeed_lbl"></span>
                </div>
            </div>
        </div>

        <div class="up text-center">
            <span data-i18n="lblPhyNetworkStatus"></span>
            <span data-i18n="lblPhyNetworkExplain"></span>
            <div>
                <span id="phyDetectText_1" data-i18n="lblPhysicalDetect"></span>
                <img src="../img/success.png" id="phyDetectImg_1" class="off">
            </div>
        </div>
        <div class="down" id="phyNet">
            <div>
                <span data-i18n="lblPhyNetworkPing"></span>
                <div>
                    <span data-i18n="lblPhyWanDisconnect" id="phyNetping_lbl"></span>
                    <img src="../img/success.png" id="phyNetping_img" class="off">
                </div>
            </div>
            <div>
                <span data-i18n="lblPhyNetworkLink"></span>
                <div>
                    <span data-i18n="lblPhyWanDisconnect" id="phyNetlink_lbl"></span>
                    <img src="../img/success.png" id="phyNetlink_img" class="off">
                </div>
            </div>
        </div>

        <div class="up text-center">
            <span data-i18n="lblPhyWiFiStatus"></span>
            <span data-i18n="lblPhyDetectWiFiStatus"></span>
            <div>
                <span id="phyDetectText_2" data-i18n="lblPhysicalDetect"></span>
                <img src="../img/success.png" id="phyDetectImg_2" class="off">
            </div>
        </div>
        <div class="down" id="phyWifi">
            <div>
                <span data-i18n="lblPhyWiFi2GStatus"></span>
                <div>
                    <span id="phyWifi2g_lbl" status="0"></span>
                    <img src="../img/success.png" id="phyWifi2g_img" class="off">
                </div>
            </div>
            <div>
                <span data-i18n="lblPhyWiFi5GStatus"></span>
                <div>
                    <span id="phyWifi5g_lbl" status="0"></span>
                    <img src="../img/success.png" id="phyWifi5g_img" class="off">
                </div>
            </div>
        </div>

        <div class="up text-center">
            <span data-i18n="lblPhyMemoryDetect"></span>
            <span data-i18n="lblPhyMemoryExplain"></span>
            <div>
                <span id="phyDetectText_3" data-i18n="lblPhysicalDetect"></span>
                <img src="../img/success.png" id="phyDetectImg_3" class="off">
            </div>
        </div>
        <div class="down" id="phyMemory">
            <div>
                <span data-i18n="lblCpu"></span>
                <span id="phyCPU"></span>
            </div>
            <div>
                <span data-i18n="lblRam"></span>
                <span id="phyMem"></span>
            </div>
        </div>
    </div>
    <div class="col-xs-3 help">
        <h4 data-i18n="lblHelp"></h4>
        <p data-i18n="msgPhysicalHelp"></p>
    </div>
</div>

<div class="modal fade" id="physicalModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content theme-border-color">
            <div class="modal-header">
                <h5 class="modal-title" id="physicalModalLabel" data-i18n="lblTips"></h5>
            </div>
            <div class="modal-body" id="phyModalTips" data-i18n="msgPhysicalText1"></div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-xs-4 col-xs-offset-2">
                        <button type="button" class="btn btn-default" data-dismiss="modal" data-i18n="btnCancel"></button>
                    </div>
                    <div class="col-xs-4">
                        <button type="button" class="btn btn-primary theme-bg-color" id="phyConfirmBtn" data-i18n="lblConfirmName"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    try{
        $;
    }catch(e){
        window.sessionStorage.setItem("page", "/setting/physical.html");
        window.location.replace("./index.html");
    }

    $(document).ready(function(){
        $("#phyDetectBtn").on("click", function(){
            $("#phyStart").hide();
            $("#phyDetecting").show();
            $("[id^='phyDetectText_']").text($.t("lblPhysicalWaitDetect"));
            $("#phyDetectText_0").text($.t("lblPhysicalDetecting"));
            net_dia_start();
        });

        $("#phyCompleteBtn").on("click", function(){
            var btn = $(this).text();
            if (btn == $.t("btnPhyRepair")) {
                var wifi2g = $("#phyWifi2g_lbl").attr("status");
                var wifi5g = $("#phyWifi5g_lbl").attr("status");
                $("#phyModalTips").text($.t((wifi2g == "-1" || wifi5g == "-1") ? "msgPhysicalText1" : "msgPhysicalText2"));
                $("#physicalModal").modal("show");
            } else if (btn == $.t("btnPhyAgain")) {
                $("#phyWan, #phyNet, #phyWifi, #phyMemory, #phyComplete").hide();
                $("#phyTime").text("0%");

                $("[id^='phyDetectText_']").text($.t("lblPhysicalWaitDetect")).show();
                $("#phyDetectText_0").text($.t("lblPhysicalDetecting"));

                $("[id$='_lbl']").text($.t("lblPhyWanDisconnect")).show();
                $("[id^='phyDetectImg_'], [id$='_img']").hide().attr("src", "../img/success.png");
                $("#phyWifi2g_lbl, #phyWifi5g_lbl, #phyCPU, #phyMem").text("");

                $("#phyDetecting").show();

                net_dia_start();
            }
        });

        $("#phyConfirmBtn").on("click", function(){
            $("#physicalModal").modal("hide");
            var wifi2g = $("#phyWifi2g_lbl").attr("status");
            var wifi5g = $("#phyWifi5g_lbl").attr("status");
            if (wifi2g == "-1" || wifi5g == "-1") {
                reboot();
            } else {
                $("#loadingBarModal .modal-title").text($.t("lblPhyTitle"));
                setProgressBar(200, $.t("msgWaiting"), $.t("msgRefresh"));
            }
        });

        function net_dia_wifi_show(wifi_num, up_img_id, down_lbl_id, down_img_id) {
            if (wifi_num == -2) {
                $(up_img_id+", "+down_img_id).attr("src", "../img/warning.png");
                $(down_lbl_id).attr("status", "-2").text("Unknown");
            } else if (wifi_num == -1) {
                $(up_img_id+", "+down_img_id).attr("src", "../img/warning.png");
                $(down_lbl_id).attr("status", "-1").text($.t("lblPhyWiFiStatus1"));
            } else if (wifi_num <= 10) {
                $(down_lbl_id).attr("status", "0").hide();
            } else {
                $(down_lbl_id).attr("status", "1").text($.t("lblPhyWiFiStatus2"));
                $(up_img_id+", "+down_img_id).attr("src", "../img/warning.png");
            }

            $(down_img_id).show();
        }

        function net_dia_start() {
            var j = 0;
            var progress = setInterval(function() {
                $("#phyTime").text(j + "%");
                if (j == 24) {
                    $("#phyDetectText_0").text($.t("lblPhysicalDetectComplete"));
                    $("#phyDetectText_1").text($.t("lblPhysicalDetecting"));
                } else if (j == 48) {
                    $("#phyDetectText_1").text($.t("lblPhysicalDetectComplete"));
                    $("#phyDetectText_2").text($.t("lblPhysicalDetecting"));
                } else if (j == 72) {
                    $("#phyDetectText_2").text($.t("lblPhysicalDetectComplete"));
                    $("#phyDetectText_3").text($.t("lblPhysicalDetecting"));
                } else if (j == 96) {
                    $("#phyDetectText_3").text($.t("lblPhysicalDetectComplete"));
                }
                if (j >= 100) {
                    clearInterval(progress);
                    progress = null;
                    getNetDiagnostics();
                }
                j++;
            }, 180);
        }

        function getNetDiagnostics() {
            ajax({
                url: "network.json",
                success: function(data) {
                    if (data.error == 0) {
                        var phy = data.diagnostics;
                        if (phy.wan_link == 0) {
                            $("[id^='phyDetectText_']").hide();
                            $("[id^='phyDetectImg_']").show().attr("src", "../img/warning.png");
                        } else {
                            $("#phyWanlink_lbl").hide();
                            $("#phyWanlink_img").show();

                            if (phy.wan_ip == 0) {
                                $("#phyWanip_lbl").text($.t("msgPhysicalErr1"));
                                $("#phyWanip_img, #phyDetectImg_0").attr("src", "../img/warning.png");
                            } else {
                                $("#phyWanip_lbl").hide();
                            }
                            $("#phyWanip_img").show();

                            if (phy.wan_duplex == 2 && phy.wan_speed >= 0) {
                                $("#phyWanspeed_lbl").text($.t("lblPhyWanSpeed") + phy.wan_speed + "M " + $.t("lblPhyWanDuplexFull"));
                            } else if (phy.wan_duplex == 1 && phy.wan_speed >= 0) {
                                $("#phyWanspeed_lbl").text($.t("lblPhyWanSpeed") + phy.wan_speed + "M " + $.t("lblPhyWanDuplexHalf"));
                            } else {
                                $("#phyWanspeed_lbl").text("Unknown");
                                $("#phyDetectImg_0").attr("src", "../img/warning.png");
                            }
                            $("#phyDetectText_0").hide();
                            $("#phyDetectImg_0").show();

                            if (phy.ping_gateway == 0) {
                                $("#phyNetping_lbl").text($.t("msgPhysicalErr4"));
                                $("#phyNetping_img, #phyDetectImg_1").attr("src", "../img/warning.png");
                            } else {
                                $("#phyNetping_lbl").hide();
                            }
                            $("#phyNetping_img").show();

                            if (phy.dns_analysis == 0) {
                                $("#phyNetlink_lbl").text($.t("msgPhysicalErr2"));
                                $("#phyNetlink_img, #phyDetectImg_1").attr("src", "../img/warning.png");
                            } else if(phy.ping_ip == 0) {
                                $("#phyNetlink_lbl").text($.t("msgPhysicalErr3"));
                                $("#phyNetlink_img, #phyDetectImg_1").attr("src", "../img/warning.png");
                            } else if(phy.ping_gateway == 0) {
                                $("#phyNetlink_lbl").text($.t("msgPhysicalErr4"));
                                $("#phyNetlink_img, #phyDetectImg_1").attr("src", "../img/warning.png");
                            } else {
                                $("#phyNetlink_lbl").hide();
                            }
                            $("#phyDetectText_1").hide();
                            $("#phyNetlink_img, #phyDetectImg_1").show();
                        }

                        net_dia_wifi_show(phy.wifi_2g_num, "#phyDetectImg_2", "#phyWifi2g_lbl", "#phyWifi2g_img");
                        net_dia_wifi_show(phy.wifi_5g_num, "#phyDetectImg_2", "#phyWifi5g_lbl", "#phyWifi5g_img");
                        $("#phyDetectText_2").hide();
                        $("#phyDetectImg_2").show();

                        var cpu_usage = 100 - phy.cputime;
                        if (cpu_usage == 0) {
                            cpu_usage = 1;
                        }
                        $("#phyCPU").text(cpu_usage + "%");
                        var ram_usage = ((phy.totalram - phy.freemem) / phy.totalram * 100).toFixed(0);
                        $("#phyMem").text(ram_usage + "%");
                        $("#phyDetectText_3").hide();
                        $("#phyDetectImg_3").show();

                        var wifi2g = $("#phyWifi2g_lbl").attr("status");
                        var wifi5g = $("#phyWifi5g_lbl").attr("status");
                        $("#phyCompleteBtn").text((wifi2g == -1 || wifi5g == -1 || wifi2g == 1 || wifi5g == 1) ? $.t("btnPhyRepair")
                                                  : $.t("btnPhyAgain"));

                        $("#phyDetecting").hide();
                        $("#phyComplete, #phyWan, #phyNet, #phyWifi, #phyMemory").show();
                    } else {
                        locationUrl(data.error);
                    }
                }
            });
        }
    });
</script>
