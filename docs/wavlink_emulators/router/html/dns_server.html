<div class="page-content row">
    <div class="col-xs-9 content">
        <div class="form-group row">
            <label class="col-xs-8 control-label" data-i18n="lblCustomDNSServer"></label>
            <div class="col-xs-4 text-right">
                <div class="switch">
                    <input class="switch-checkbox hidden" id="enableDNSServer" type="checkbox">
                    <label class="switch-label" for="enableDNSServer">
                        <span class="switch-inner"></span>
                    </label>
                </div>
            </div>
        </div>
        <div class="off" id="dnsprotocolinfo">
            <div class="form-group row">
                <label class="col-xs-7 control-label" data-i18n="lblDNSServerProtocol"></label>
                <div class="col-xs-5">
                    <select class="form-control" id="dnsprotocol">
                        <option value="0" selected="selected">DNS over HTTPS</option>
                        <option value="1">DNS over TLS</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="off" id="dohinfo">
            <div class="form-group row">
                <label class="col-xs-7 control-label" data-i18n="lblDNSServerProvider"></label>
                <div class="col-xs-5">
                    <select class="form-control" id="dohserver">
                        <option value="0" url="https://cloudflare-dns.com/dns-query">Cloudflare</option>
                        <option value="1" url="https://doh.cleanbrowsing.org/doh/family-filter/">CleanBrowsing</option>
                        <option value="2" url="https://dns.adguard.com/dns-query">AdGuard</option>
                        <option value="3" url="https://doh.opendns.com/dns-query">OpenDns</option>
                        <option value="4" data-i18n="btnSelfDefine"></option>
                    </select>
                </div>
            </div>
            <div class="off" id="dohinfoself">
                <div class="form-group row">
                    <label class="col-xs-7 control-label"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="dohinfoselfserver">
                    </div>
                </div>
            </div>
        </div>
        <div class="off" id="dotinfo">
            <div class="form-group row">
                <label class="col-xs-7 control-label" data-i18n="lblDNSServerProvider"></label>
                <div class="col-xs-5">
                    <select class="form-control" id="dotserver">
                        <option value="0" url="1dot1dot1dot1.cloudflare-dns.com" ip="1.0.0.1">Cloudflare</option>
                        <option value="1" url="dns.cleanbrowsing.org" ip="185.228.169.9">CleanBrowsing</option>
                        <option value="2" url="dns-family.adguard.com" ip="94.140.15.16">AdGuard</option>
                        <option value="3" data-i18n="btnSelfDefine"></option>
                    </select>
                </div>
            </div>
            <div class="off" id="dotinfoself">
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="vpn_client_server_addr"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="dotinfoip">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="vpn_client_server_domain"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="dotinfourl">
                    </div>
                </div>
            </div>
            <hr class="depart-line">
            <div class="form-group row">
                <label class="col-xs-7 control-label" data-i18n="lblDdnsStatus"></label>
                <div class="col-xs-5 text-right" data-i18n="lblOffline" id="dnsdotstatus"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-4 col-xs-offset-4">
                <button class="btn btn-primary theme-bg-color" id="setdnsserver" data-i18n="btnSaveName"></button>
            </div>
        </div>
    </div>
    <div class="col-xs-3 help">
        <h4 data-i18n="lblHelp"></h4>
        <h5 data-i18n="lblCustomDNSServer"></h5>
        <p data-i18n="msgCustomDNSServerHelp"></p>
    </div>
</div>

<script>
	try{
		$;
	}catch(e){
		window.sessionStorage.setItem("page", "/setting/dns_server.html");
		window.location.replace("./index.html");
	}

    $(document).ready(function(){
        getDNSServer();

        $("#enableDNSServer").on("change", function() {
            if ($(this).is(":checked")) {
                $("#dnsprotocolinfo").show();
                $("#dnsprotocol").change();
            } else {
                $("#dnsprotocolinfo, #dohinfo, #dotinfo").hide();
            }
        });

        $("#dnsprotocol").on("change", function() {
            var server = $(this).val()*1;
            if (server == 0) {
                $("#dohinfo").show();
                $("#dotinfo").hide();
            } else {
                $("#dotinfo").show();
                $("#dohinfo").hide();
            }
        });

        $("#dohserver").on("change", function() {
            $(this).val()*1 == 4 ? $("#dohinfoself").show() : $("#dohinfoself").hide();
        });

        $("#dotserver").on("change", function() {
            $(this).val()*1 == 3 ? $("#dotinfoself").show() : $("#dotinfoself").hide();
        });

        $("#setdnsserver").on("click", function() {
            var enable = $("#enableDNSServer").val();
            var protocol = $("#dnsprotocol").val();
            var server_id = 0;
            var server_ip = ""
            var server_url = "";
            var exp_ip = /^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;
            var exp_url = /(([\w\-]+\.)+[\w\-]+(\/[\w\u4e00-\u9fa5\-\.\/?\@\%\!\&=\+\~\:\,]*)?)/ig;
            if (enable == 1) {
                if (protocol == 0) {
                    server_id = $("#dohserver").val();
                    if (server_id == 4) {
                        server_url = $("#dohinfoselfserver").val();

                        if (server_url == "") {
                            getMsg($.t("msgIpNone"), 2, $("#dohinfoselfserver"));
                            return false;
                        }
                        var reg = server_url.match(exp_url);
                        if (reg == null) {
                            getMsg($.t("msgDNSServerUrlerror"), 2, $("#dohinfoselfserver"));
                            return false;
                        }
                    } else {
                        var option_val= "option[value=" + server_id + "]"
                        server_url = $('#dohserver').find(option_val).attr("url");
                    }
                } else if (protocol == 1) {
                    server_id = $("#dotserver").val();
                    if (server_id == 3) {
                        server_ip = $("#dotinfoip").val();
                        server_url = $("#dotinfourl").val();

                        if (server_ip == "") {
                            getMsg($.t("msgIpNone"), 2, $("#dotinfoip"));
                            return false;
                        }
                        var reg = server_ip.match(exp_ip);
                        if (reg == null) {
                            getMsg($.t("msgDNSServerIPerror"), 2, $("#dotinfoip"));
                            return false;
                        }

                        if (server_url == "") {
                            getMsg($.t("msgIpNone"), 2, $("#dotinfourl"));
                            return false;
                        }
                        var reg = server_url.match(exp_url);
                        if (reg == null) {
                            getMsg($.t("msgDNSServerUrlerror"), 2, $("#dotinfourl"));
                            return false;
                        }
                    } else {
                        var option_val= "option[value=" + server_id + "]"
                        server_ip = $('#dotserver').find(option_val).attr("ip");
                        server_url = $('#dotserver').find(option_val).attr("url");
                    }
                }
            }
            startLoading(2000, $.t("btnSaveName"));
        });

        function getDNSServer() {
            ajax({
                url: "network.json",
                success: function(data) {
                    if (data.error == 0) {
                        var server = data.dns_server;
                        $("#dnsprotocol").val(server.protocol).change();
                        if (server.enable == 1) {
                            if (server.protocol == 0) {
                                $("#dohserver").val(server.server_id).change();
                                if (server.server_id == 4) {
                                    $("#dohinfoselfserver").val(server.server_url);
                                }
                            } else if (server.protocol == 1) {
                                $("#dotserver").val(server.server_id).change();
                                if (server.server_id == 3) {
                                    $("#dotinfoip").val(server.server_ip);
                                    $("#dotinfourl").val(server.server_url);
                                }
                                $("#dnsdotstatus").text($.t(server.status ? "lblOnline" : "lblOffline"));
                            }
                        }
                        $("#enableDNSServer").prop("checked", server.enable == 1).change();
                    } else {
                        locationUrl(data.error);
                    }
                }
            });
        }
    });
</script>
