<div class="page-content row">
    <div class="col-xs-9 content">
        <div class="form-group row">
            <label class="col-xs-8 control-label" data-i18n="tWireGuard_client"></label>
            <div class="col-xs-4 text-right">
                <div class="switch">
                    <input class="switch-checkbox hidden" id="EnableWGCli" type="checkbox">
                    <label class="switch-label" for="EnableWGCli">
                        <span class="switch-inner"></span>
                    </label>
                </div>
            </div>
        </div>
        <div id="wireGuardClient" class="off">
            <div class="form-group row">
                <label class="col-xs-7 control-label" data-i18n="lblReceive"></label>
                <div class="col-xs-5 text-right" id="wireGuardReceive"></div>
            </div>
            <div class="form-group row">
                <label class="col-xs-7 control-label" data-i18n="lblSent"></label>
                <div class="col-xs-5 text-right" id="wireGuardSend"></div>
            </div>
            <div class="tab" style="display:flex;margin-bottom: 5px;" id="wireGuardCliTab">
                <a href="#" data-i18n="lblUpload" style="color: #333333;padding: 5px 10px;"></a>
                <a href="#" data-i18n="lblManualInput" style="color: #333333;padding: 5px 10px;"></a>
            </div>
            <hr class="depart-line">
            <div class="wireGuardCliConnect off">
                <div class="form-group row">
                    <label class="col-xs-4 control-label" data-i18n="lblWireGuardConfigFile"></label>
                </div>
                <div class="form-group row">
                    <div class="col-xs-4 col-xs-offset-4">
                        <input type="text" class="form-control selectFile" id="wireGuardChooseFile"
                            data-i18n="[placeholder]lblChooseWireGuardFile" readonly />
                        <input type="file" class="hidden" id="wireGuardSelectedFile" />
                        <img src="../img/folder.png" class="selectFile" />
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-xs-4 col-xs-offset-4">
                        <button class="btn btn-primary theme-bg-color" id="wireGuardFileBtn"
                            data-i18n="lblUpload"></button>
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-xs-4 col-xs-offset-4">
                        <button class="btn btn-primary theme-bg-color" id="wireGuardFileSave"
                            data-i18n="lblSave"></button>
                    </div>
                </div>
                <div id="wireGuardFileConnect">
                    <div class="form-group row">
                        <label class="col-xs-4 control-label" data-i18n="lblWireGuardConfig"></label>
                    </div>
                    <textarea id="wireGuardFileText" cols="65" rows="13"></textarea>
                </div>
            </div>
            <div class="wireGuardCliConnect off">
                <div class="form-group row">
                    <label class="col-xs-4 control-label" style="color: #3371B7;" data-i18n="lblInterface"></label>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblAddresses"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="wireGuardCliAddresses">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblPrivateKey"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="wireGuardCliPrivateKey">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblMTU"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="wireGuardCliMtu">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblListenPort"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="wireGuardCliListenPort">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblDNS"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="wireGuardCliDNS">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-4 control-label" style="color: #3371B7;" data-i18n="lblPeer"></label>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblEndpointIP"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="wireGuardCliEndpoint">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblEndpointPort"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="wireGuardCliPort">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblAllowips"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="wireGuardCliAllowips">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblPublicKey"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="wireGuardCliPublicKey">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblPresharedKey"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" placeholder="" id="wireGuardCliPresharedcKey">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-xs-7 control-label" data-i18n="lblKeepPalive"></label>
                    <div class="col-xs-5">
                        <input type="text" class="form-control" id="wireGuardCliKeepalive">
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-4 col-xs-offset-4">
                        <button class="btn btn-primary theme-bg-color" id="wireGuardManualSave" data-i18n="lblSave"></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-4 col-xs-offset-4">
                <button class="btn btn-primary theme-bg-color" id="wireGuardCliSave" data-i18n="btnSaveName"></button>
            </div>
        </div>
    </div>
    <div class="col-xs-3 help">
        <h4 data-i18n="lblHelp"></h4>
        <p>
            <span data-i18n="lblWireGuardTip"></span>
        </p>
    </div>
</div>

<script>
    try{
        $;
    }catch(e){
        window.sessionStorage.setItem("page", "/setting/wireguard_client.html");
        window.location.replace("./index.html");
    }

    $(document).ready(function () {
        const wireGuard = {
            status: 0,
            uploadFile: 0,
            manual: 0
        };

        getWireGuardClient();

        $("#wireGuardCliTab").on("click", "a", function () {
            $(this).addClass("active").siblings("a").removeClass("active");
            $("#wireGuardClient > .wireGuardCliConnect").eq($(this).index()).show().siblings(".wireGuardCliConnect").hide();
        })

        $("#EnableWGCli").on("click", function () {
            if (wireGuard.status != 2) {
                if ($(this).is(":checked")) {
                    if (wireGuard.status == 0 || wireGuard.status == 1) {
                        $("#wireGuardCliTab a:first").addClass("active").siblings("a").removeClass("active");
                        $("#wireGuardClient > .wireGuardCliConnect:first").show().siblings(".wireGuardCliConnect").hide();
                    } else if (wireGuard.status == 3) {
                        $("#wireGuardCliTab a").eq(wireGuard.manual).addClass("active").siblings("a").removeClass("active");
                        $("#wireGuardClient > .wireGuardCliConnect").eq(wireGuard.manual).show().siblings(".wireGuardCliConnect").hide();
                    }
                    $("#wireGuardCliSave").hide();
                    $("#wireGuardClient").show();
                } else {
                    $("#wireGuardClient").hide();
                    $("#wireGuardCliSave").show();
                }
            } else {
                $("#wireGuardClient").prop("checked", false).val(0);
                getMsg($.t("msgWireGuardEnableError"));
                return false;
            }
        });

        $("#wireGuardFileBtn").on("click", function () {
            let myData = $("#wireGuardSelectedFile")[0].files[0];

            if (myData == undefined) {
                getMsg($.t("msgBrowseWireGuardFilerror1"));
                return;
            }
            if (myData.size > 10240) {
                getMsg($.t("msgUploadFileSize"));
                return;
            }
            //File format restriction
            let name = $("#wireGuardChooseFile").val();
            let fileType = name.lastIndexOf(".");
            if (name.substr(fileType) != ".conf") {
                getMsg($.t("msgBrowseWireGuardFilerror3"));
                return;
            }
            startLoading(3000, $.t("msgUploading"));
            let reader = new FileReader();
            reader.onload = function () {
                $("#wireGuardFileText").val(this.result);
            }
            reader.readAsText(myData);
            wireGuard.uploadFile = 1;
        });

        $("#wireGuardFileSave").on("click", function () {
            if (wireGuard.uploadFile == 0) {
                getMsg($.t("msgBrowseWireGuardFilerror2"));
                return;
            } else {
                wireGuard.manual = 0;
                setProgressBar(100, $.t("msgWaiting"), $.t("msgRefresh"));
                wireGuard.uploadFile = 0;
            }
        });

        $("#wireGuardManualSave").on("click", function () {
            if (wireGuard.uploadFile === 1) {
                wireGuard.manual = 0;
                setProgressBar(100, $.t("msgWaiting"), $.t("msgRefresh"));
                wireGuard.uploadFile = 0;
            } else {
                let address = $("#wireGuardCliAddresses").val().trim();
                let listen_port = $("#wireGuardCliListenPort").val().trim();
                let private_key = $("#wireGuardCliPrivateKey").val().trim();
                let mtu = $("#wireGuardCliMtu").val().trim();
                let dns = $("#wireGuardCliDNS").val().trim();
                let allowips = $("#wireGuardCliAllowips").val().trim();
                let endpoint = $("#wireGuardCliEndpoint").val().trim();
                let port = $("#wireGuardCliPort").val().trim();
                let public_key = $("#wireGuardCliPublicKey").val().trim();
                let preshared_key = $("#wireGuardCliPresharedcKey").val().trim();
                let keepalive = $("#wireGuardCliKeepalive").val().trim();

                if (!(/^(?:(?:[0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}(?:[0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\/([1-9]|[1-2]\d|3[0-2])$/.test(address))) {
                    getMsg($.t("msgAddressesError"), 1, "#wireGuardCliAddresses");
                } else if (private_key.length <= 0) {
                    getMsg($.t("msgIpNone"), 1, "#wireGuardCliPrivateKey");
                } else if (mtu.length != 0 && (!(/^\d+$/.test(mtu)) || parseInt(mtu) <= 0 || parseInt(mtu) > 1500)) {
                    getMsg($.t("msgMTUError"), 1, "#wireGuardCliMtu");
                } else if (listen_port.length != 0 && (!(/^\d+$/.test(listen_port)) || parseInt(listen_port) <= 0 || parseInt(listen_port) > 65535)) {
                    getMsg($.t("msgPortError1"), 1, "#wireGuardCliListenPort");
                } else if (dns.length != 0 && !checkIP($("#wireGuardCliDNS"), 2)) {
                } else if (!checkIP($("#wireGuardCliEndpoint"), 1)) {

                } else if ((!(/^\d+$/.test(port))) || parseInt(port) <= 0 || parseInt(port) > 65535) {
                    getMsg($.t("msgPortError1"), 1, "#wireGuardCliPort");
                } else if (allowips.length == 0) {
                    getMsg($.t("msgIpNone"), 1, "#wireGuardCliAllowips");
                } else if (public_key.length <= 0) {
                    getMsg($.t("msgIpNone"), 1, "#wireGuardCliPublicKey");
                } else if (keepalive.length != 0 && (!(/^\d+$/.test(keepalive)) || parseInt(keepalive) <= 0 || parseInt(keepalive) > 125)) {
                    getMsg($.t("msgKeepaliveError"), 1, "#wireGuardCliKeepalive");
                } else {
                    wireGuard.manual = 1;
                    setProgressBar(100, $.t("msgWaiting"), $.t("msgRefresh"));
                }
            }
        });

        $("#wireGuardCliSave").on("click", function () {
            if (wireGuard.status == 3) {
                setProgressBar(100, $.t("msgWaiting"), $.t("msgRefresh"));
            }
        });

        function getWireGuardClient() {
            $("#wireGuardReceive, #wireGuardSend").text("0 B");
            $(".wireGuardCliConnect").find("input").val("");
            $("#wireGuardFileText").val("");
            ajax({
                url: "vpn.json",
                success: function (data) {
                    if (data.error == 0) {
                        var client = data.wguard_client;
                        wireGuard.status = client.status;
                        wireGuard.manual = client.manual;
                        var receiveData = client.strData.split(" ");
                        if (/^-?\d+(\.\d+)?$/.test(receiveData[1]) && /^-?\d+(\.\d+)?$/.test(receiveData[4])) {
                            $("#wireGuardReceive").text(receiveData[1] + " " + receiveData[2]);
                            $("#wireGuardSend").text(receiveData[4] + " " + receiveData[5]);
                        }
                        if (client.status == 3) {
                            if (client.manual == 1) {
                                $("#wireGuardCliAddresses").val(client.interface.address);
                                $("#wireGuardCliPrivateKey").val(client.interface.private_key);
                                if (client.interface.mtu != 0) {
                                    $("#wireGuardCliMtu").val(client.interface.mtu);
                                }
                                if (client.interface.listen_port != 0) {
                                    $("#wireGuardCliListenPort").val(client.interface.listen_port);
                                }
                                if (client.interface.dns.length != 0) {
                                    $("#wireGuardCliDNS").val(client.interface.dns);
                                }
                                $("#wireGuardCliAllowips").val(client.peer.allowips);
                                $("#wireGuardCliEndpoint").val(client.peer.endpoint);
                                if (client.peer.port != 0) {
                                    $("#wireGuardCliPort").val(client.peer.port);
                                }
                                $("#wireGuardCliPublicKey").val(client.peer.public_key);
                                if (client.peer.preshared_key.length != 0) {
                                    $("#wireGuardCliPresharedcKey").val(client.peer.preshared_key);
                                }
                                if (client.peer.keepalive != 0) {
                                    $("#wireGuardCliKeepalive").val(client.peer.keepalive);
                                }
                            } else if (client.manual == 0) {
                                const fileArr = client.fileArr;
                                const fileText = $("#wireGuardFileText");
                                fileText.val("");

                                for (let i = 0, len = fileArr.length; i < len; ++i) {
                                    fileText.val(fileText.val() + fileArr[i]);
                                }
                            }

                            $("#wireGuardCliTab a").eq(wireGuard.manual).addClass("active").siblings("a").removeClass("active");
                            $("#wireGuardClient > .wireGuardCliConnect").eq(wireGuard.manual).show().siblings(".wireGuardCliConnect").hide();

                            if (!$("EnableWGCli").is(":checked")) {
                                $("#EnableWGCli").prop("checked", true).val(1);
                                $("#wireGuardClient").show();
                                $("#wireGuardCliSave").hide();
                            }
                        } else {
                            $("#EnableWGCli").prop("checked", false).val(0);
                            $("#wireGuardClient").hide();
                        }
                    } else {
                        locationUrl(data.error);
                    }
                }
            })
        }
    });
</script>
