<div class="page-content row">
    <div class="col-xs-9 content">
        <div class="form-group row">
            <label class="col-xs-8 control-label" data-i18n="lblWireGuardServer"></label>
            <div class="col-xs-4 text-right">
                <div class="switch">
                    <input class="switch-checkbox hidden" id="enable_wireguard_ser" type="checkbox">
                    <label class="switch-label" for="enable_wireguard_ser">
                        <span class="switch-inner"></span>
                    </label>
                </div>
            </div>
        </div>
        <div id="wireguard_server" class="off">
            <div class="form-group row">
                <label class="col-xs-7 control-label" data-i18n="lblAddr"></label>
                <div class="col-xs-5">
                        <input type="text" class="form-control" id="wireguard_ip">
                </div>
            </div>
            <div class="form-group row">
                <label class="col-xs-7 control-label" data-i18n="lblWireGuardLocalPort"></label>
                <div class="col-xs-5">
                    <input type="text" class="form-control" id="wireguard_port"/>
                </div>
            </div>
            <div class="form-group row includeAddRule off">
                <button type="button" class="btn btn-default" id="addRule">
                    <img src="../img/add.png">
                    <span data-i18n="lblWireGuardAddUser"></span>
                </button>
            </div>
            <div class="row">
                <table id="vpnserverList" class="table off">
                    <thead>
                        <tr>
                            <th data-i18n="lblUserName"></th>
                            <th data-i18n="lblAddr"></th>
                            <th data-i18n="lblWireGuardConfig"></th>
                            <th data-i18n="lblOperate"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <h5 class="depart-line collapsed theme-border-color theme-color off"
                data-toggle="collapse" href="#vpnserverinfo"
                aria-expanded="false" aria-controls="vpnserverinfo">
                <span data-i18n="upnp_list_show"></span>
                <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span>
            </h5>
            <div class="collapse" id="vpnserverinfo">
                <table id="wgserverList" class="table">
                    <thead>
                        <tr>
                            <th data-i18n="lblUserName"></th>
                            <th data-i18n="lblAddr"></th>
                            <th data-i18n="lblReceiveByte"></th>
                            <th data-i18n="lblSentByte"></th>
                            <th data-i18n="lblLatestHandshake"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-4 col-xs-offset-4">
                <button class="btn btn-primary theme-bg-color" id="save_wireguard_ser" data-i18n="lblSave"></button>
            </div>
        </div>
    </div>
    <div class="col-xs-3 help">
        <h4 data-i18n="lblHelp"></h4>
        <p data-i18n="lblWireGuardTip"></p>
    </div>
</div>

<script>
    try{
        $;
    }catch(e){
        window.sessionStorage.setItem("page", "/setting/wireguard_server.html");
        window.location.replace("./index.html");
    }

    $(document).ready(function(){
        var ClientInfoList = [], wg_type;
        getwireguardser();
        $("#enable_wireguard_ser").on("change", function(){
            if(wg_type!="client"){
                $(this).is(":checked") ? $("#wireguard_server").show() : $("#wireguard_server").hide();
            }else{
                $("#enable_wireguard_ser").prop("checked",false).val(0);
                getMsg($.t("msgVpnEnableError"));
            }
        });
        $(".depart-line[data-toggle='collapse']").on("click", function(){
            var target = $(this);
            $(this).find(".glyphicon").attr("class", function(i, v){
                return target.hasClass("collapsed") ? v.replace("right", "down") : v.replace("down", "right");
            });
        });

        $("#vpnserverList > tbody").on("click", ".editThis:not(.disabled)", function(){
            var thisTr = $(this).parents("tr");
            var index = thisTr.prevAll().length;
            var name = thisTr.find(".name").val();
            var ip = thisTr.find(".ip").val();
            if(name == ""){
                getMsg($.t("msgIpNone"), 1, thisTr.find(".name"));
                return false;
            } else if(!SsidLenCheck(name, 64)){
                getMsg($.t("msgInputLengthError"), 1, thisTr.find(".name"));
                return false;
            } else if(/\s/.test(name)){
                getMsg($.t("msgIPv6SpaceError"), 1, thisTr.find(".name"));
                return false;
            }
            if (!checkIP(thisTr.find(".ip"), 1)) {
                return false;
            }
            startLoading(2000, $.t("btnSaveName"));
            thisTr.find("td:eq(0)").html(name);
            thisTr.find("td:eq(1)").html(ip);
            thisTr.find("td:eq(2)").html("<a class='exportFile' download='vpn.conf' href='../data/ovpn'><img src='../img/download_02.png'></a>");
            thisTr.find("td:eq(3)").html("<span class='deleteThis'>"+$.t("btnDelete")+"</span>");
            $("#vpnserverList tbody span.disabled").removeClass("disabled");
        });

        $("#vpnserverList > tbody").on("click", ".deleteThis:not(.disabled)", function(){
            var thisTr = $(this).parents("tr");
            var index = thisTr.prevAll().length;
            console.log(index);
            if($(this).text() == $.t("btnCancel")){
                thisTr.remove();
                $("#vpnserverList tbody span.disabled").removeClass("disabled");
            }else{
                thisTr.remove();
                startLoading(2000, $.t("btnDelete"));
            }
        });

        $("#save_wireguard_ser").on("click",function(){
            var enable = $("#enable_wireguard_ser").val();
            var wgvpn_ip = $("#wireguard_ip").val();
            var wgvpn_port = $("#wireguard_port").val();
            if(enable==0){
                setProgressBar(100, $.t("msgWaiting"), $.t("msgRefresh"));
                return ;
            }
            if(!checkPort($("#wireguard_port")) || !checkIP($("#wireguard_ip"), 1)) {
                return false;
            }
            setProgressBar(100, $.t("msgWaiting"), $.t("msgRefresh"));
        });

        $("#addRule").on("click",function(){
            if (ClientInfoList.length >= 32) {
                getMsg($.t("msgAlert5"));
                return false;
            }
            if ($("#vpnserverList tbody input").length <= 0) {
                $("#vpnserverList tbody span").addClass("disabled");
                var newTr = $("<tr><td><input type='text' class='form-control name' /></td>\
                                <td><input type='text' class='form-control ip'></input></td><td></td>\
                                <td><span class='editThis'>"+$.t("lblConfirmName")+"</span>\
                                <span class='deleteThis'>"+$.t("btnCancel")+"</span></td></tr>");
                $("#vpnserverList tbody").append(newTr);
            }
        });

        function getwireguardser(){
            ajax({
                url: "vpn.json",
                success: function(data) {
                    if (data.error == 0) {
                        var server = data.wguard_server;
                        wg_type = server.wg_type;
                        $("#wireguard_ip").val(server.wgvpn_ip);
                        $("#wireguard_port").val(server.wgvpn_port<=0 || server.wgvpn_port>65535 ? 51820 : server.wgvpn_port);
                        if(server.disabled==0 && server.wg_type!="client"){
                            $("#enable_wireguard_ser").prop("checked", true).val(1);
                            $("#wireguard_server, #vpnserverList, .theme-color, .includeAddRule").show();
                        }else{
                            $("#wireguard_server, #vpnserverList, .theme-color, .includeAddRule").hide();
                        }

                        ClientInfoList = server.server_user_list;
                        var dom = document.createDocumentFragment(), dom2 = document.createDocumentFragment();
                        ClientInfoList.forEach(function(v){
                            if(v.name && v.ip){
                                dom.appendChild($("<tr><td>"+v.name+"</td>\
                                                <td>"+v.ip+"</td>\
                                                <td><a class='exportFile' download='vpn.conf' href='../data/ovpn'><img src='../img/download_02.png'></a></td>\
                                                <td><span class='deleteThis'>"+$.t("btnDelete")+"</span></td></tr>")[0]);
                            }
                        });
                        $("#vpnserverList > tbody").html(dom);
                        server.connect_user_list.forEach(function(v){
                            if(v.name && v.addr){
                                dom2.appendChild($("<tr><td>"+v.name+"</td>\
                                                    <td>"+v.addr+"</td>\
                                                    <td>"+v.received+"</td>\
                                                    <td>"+v.sent+"</td>\
                                                    <td id=time"+index+">"+(v.time<=3600?formatSeconds(v.time)+" "+$.t("lblAgo"):"")+"</td></tr>")[0]);
                            }
                        });
                        $("#wgserverList > tbody").html(dom2);
                    } else {
                        locationUrl(data.error);
                    }
                }
            });
        }
    });
</script>
