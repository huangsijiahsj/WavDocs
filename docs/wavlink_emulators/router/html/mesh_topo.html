<div class="page-content row">
	<div class="col-xs-12 content">
		<div class="row">
			<div id="meshTopo">
				<canvas id="meshTopoCanvas" width="100%" height="500px"></canvas>
			</div>
		</div>
	</div>
</div>

<script src="../public/static/jtopo-0.4.8-min.js"></script>
<script>
	try{
		$;
	}catch(e){
		window.sessionStorage.setItem("page", "/setting/mesh_topo.html");
		window.location.replace("./index.html");
	}

	$(document).ready(function(){
		var extenderName, meshArr, all_ap;
		var canvas = document.getElementById("meshTopoCanvas");
		canvas.width = $("#meshTopo").width();
		var stage = new JTopo.Stage(canvas);
		var scene = new JTopo.Scene(stage);

		getAgentTopo();

		function getAgentTopo() {
			ajax({
				url: "network.json",
				success: function(data){
					if (data.error == 0) {
						meshArr = data.mesh.topology;
						extenderName = data.mesh.agent_list;
						draw(meshArr);
					} else {
						locationUrl(data.error);
					}
				}
			});
		}

		CanvasRenderingContext2D.prototype.wrapText = function(str, x, y) {
			var textArray = str.split('\n');
			if (textArray==undefined || textArray==null) return false;

			var lineHeight = this.measureText("(").width * 1.5;
			this.fillStyle = "#3d65a3";//("61,101,163")

			for (var j= 0, len = textArray.length; j < len; j++) {
				var words = textArray[j];
				this.fillText(words, -(this.measureText(textArray[j]).width/2), y);
				y += lineHeight;
			}
		};

		function addLink(node_from, node_to, type) { //0:虚线 1:实线
			var link = new JTopo.FlexionalLink(node_from, node_to);
			link.strokeColor = '142,142,142';
			link.lineWidth = 1;
			if (0 == type)
				link.dashedPattern = 2;
			link.fontColor=("255,0,0");
			scene.add(link);
			return link;
		}

		function addNode(text, type) {
			var node = new JTopo.Node();

			node.dragable=1;
			node.text = text;
			node.font = "15px Consolas";
			node.showSelected = false;
			node.paintText = function(a) {
				a.beginPath(),
				a.font = this.font,
				a.wrapText(this.text,this.height,this.height);
				a.closePath()
			};

			scene.add(node);
			if (type == "1") {  //router
				node.setImage("../img/mesh_router_t.png");
			} else if(type == "2") {  //extender
				node.setImage("../img/mesh_extender_t.png");
			} else {      //client
				node.setImage("../img/mesh_client.png");
			}
			return node;
		}

		function findName(pairKey) {
			for(var a = 0, len = extenderName.length; a < len; a++){
				if (pairKey.toUpperCase() == extenderName[a].pair_key) {
					return extenderName[a].name;
				}
			}
			return "Extender";
		}
		function link_ap_sta(arr) {
			var sta_array = arr.stationList;
			var ap_node, sta_node;

			if ("2" == arr.meshRole) {
				ap_node = addNode("", 2);
			} else {
				ap_node = addNode("Router", 1);
			}
			all_ap.push(ap_node);
			for (var i = 0, len = sta_array.length; i < len; i++) {
				if ("2" ==  sta_array[i].band) {
					sta_node = addNode(sta_array[i].mac+"\n[Ethernet]", 0);
					addLink(ap_node, sta_node, 1);
				} else {
					sta_node = addNode(sta_array[i].mac, 0);
					addLink(ap_node, sta_node, 0);
				}
			}
		}

		function link_ap(arr) {
			var ap_length = arr.length;
			for (var i = 1; i < ap_length; i++) {
				var BHMac = arr[i].BHLMac;
				var BHType = arr[i].BHLType;
				for (var j = 0; j < ap_length; j++) {
					if (i == j)
						continue;
					if ("2" == BHType) {
						if (arr[j].almac == BHMac) {
							all_ap[i].text = findName(arr[i].pairKey)+"["+arr[i].pairKey.slice(-5)+"]\n[Ethernet]";
							all_ap[i].setImage("../img/mesh_extender_t_lan.png");
							addLink(all_ap[j], all_ap[i], 1);
						}
					} else if ("1" == BHType) {
						if (arr[j].wibhmac == BHMac) {
							all_ap[i].text = findName(arr[i].pairKey)+"["+arr[i].pairKey.slice(-5)+"]\n[" + arr[i].rssi + "db]";
							addLink(all_ap[j], all_ap[i], 0);
						}
					}
				}
			}
		}

		function draw(arr) {
			all_ap = new Array();
			for (var i = 0, len = arr.length; i < len; i++) {
				link_ap_sta(arr[i]);
			}
			link_ap(arr);
			//show
			scene.doLayout(JTopo.layout.TreeLayout('down', 200, 120));
		}
	});
</script>
